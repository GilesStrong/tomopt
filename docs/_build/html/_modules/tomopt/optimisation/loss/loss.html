


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>tomopt.optimisation.loss.loss &mdash; TomOpt  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://tomopt.readthedocs.io/en/stable" aria-label="TomOpt"></a>

      <div class="main-menu">
        <ul>
          <!-- <li>
            <a href="">Get Started</a>
          </li> -->

          <!-- <li>
            <a href="">Features</a>
          </li> -->

          <!-- <li>
            <a href="">Ecosystem</a>
          </li> -->

          <!-- <li>
            <a href="">Blog</a>
          </li> -->

          <li>
            <a href="https://github.com/GilesStrong/mode_muon_tomography#examples">Tutorials</a>
          </li>

          <li>
            <a href="https://tomopt.readthedocs.io/en/stable">Docs</a>
          </li>

          <!-- <li>
            <a href="">Resources</a>
          </li> -->

          <li>
            <a href="https://github.com/GilesStrong/mode_muon_tomography">Github</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>

  </div>
</div>


<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html#testing">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html#external-repos">External repos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html#authors">Authors</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tomopt.html">tomopt package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tomopt.muon.html">tomopt.muon package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tomopt.volume.html">tomopt.volume package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tomopt.inference.html">tomopt.inference package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tomopt.optimisation.html">tomopt.optimisation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tomopt.plotting.html">tomopt.plotting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tomopt.benchmarks.html">tomopt.benchmarks package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../../index.html">Module code</a> &gt;</li>
        
      <li>tomopt.optimisation.loss.loss</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for tomopt.optimisation.loss.loss</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>

<span class="kn">from</span> <span class="nn">...volume</span> <span class="kn">import</span> <span class="n">Volume</span>
<span class="kn">from</span> <span class="nn">.sub_losses</span> <span class="kn">import</span> <span class="n">integer_class_loss</span>

<span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Provides loss functions for evaluating the performance of detector and inference configurations</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;AbsDetectorLoss&quot;</span><span class="p">,</span> <span class="s2">&quot;AbsMaterialClassLoss&quot;</span><span class="p">,</span> <span class="s2">&quot;VoxelX0Loss&quot;</span><span class="p">,</span> <span class="s2">&quot;VoxelClassLoss&quot;</span><span class="p">,</span> <span class="s2">&quot;VolumeClassLoss&quot;</span><span class="p">,</span> <span class="s2">&quot;VolumeIntClassLoss&quot;</span><span class="p">,</span> <span class="s2">&quot;VolumeMSELoss&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="AbsDetectorLoss"><a class="viewcode-back" href="../../../../tomopt.optimisation.loss.html#tomopt.optimisation.loss.loss.AbsDetectorLoss">[docs]</a><span class="k">class</span> <span class="nc">AbsDetectorLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class from which all loss functions should inherit.</span>

<span class="sd">    The loss consists of:</span>
<span class="sd">        - A component that quantifies the performance of the predictions made via the detectors</span>
<span class="sd">        - An optional component that relates to the cost of the detector</span>
<span class="sd">    The total loss is the sum of these, with the cost-component being rescaled by a coefficient characterising its relative importance.</span>

<span class="sd">    The performance component (error) should ideally be as close to the final task that the detector will be performing,</span>
<span class="sd">    and will depend on the output of the inference algorithm used</span>

<span class="sd">    The optional cost component is included as a budget weighting, which gradually increases with the current cost up to a predefined budget,</span>
<span class="sd">    after which it increases rapidly, but smoothly.</span>
<span class="sd">    Be default, the budget is based on a sigmoid centred at the budget, which linearly increases after the budget is exceeded.</span>
<span class="sd">    A less steep version is selectable, which flattens out slightly for high costs.</span>

<span class="sd">    Inheriting classes will need to at least override the `_get_inference_loss` method.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        target_budget: If not None, will include a cost component in the loss configured for the specified budget.</span>
<span class="sd">            Should be specified in the same currency units as the detector cost.</span>
<span class="sd">        budget_smoothing: controls how quickly the budget term rises with cost; lower values =&gt; slower rise</span>
<span class="sd">        cost_coef: Balancing coefficient used to multiply the budget term prior to its addition to the error component of the loss.</span>
<span class="sd">            If set to None, it will be set equal to the inference-error computed the first time the loss is computed</span>
<span class="sd">        steep_budget: If True, will use a linearly increasing budget term when the budget is exceeded,</span>
<span class="sd">            otherwise the budget term will flatten off for very high costs</span>
<span class="sd">        debug: If True, will print out information about the loss whenever it is evaluated</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">target_budget</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">budget_smoothing</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">cost_coef</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">steep_budget</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_budget</span> <span class="o">=</span> <span class="n">target_budget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">budget_smoothing</span> <span class="o">=</span> <span class="n">budget_smoothing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_coef</span> <span class="o">=</span> <span class="n">cost_coef</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steep_budget</span> <span class="o">=</span> <span class="n">steep_budget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sub_losses</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Store subcomponents in dict for telemetry</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_get_inference_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="n">Volume</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inheriting classes must override this to compute the inference-error component of the loss.</span>
<span class="sd">        The target for the predictions should be extracted from the volume; whether this be the voxelwise X0s or the value of the `target` attribute.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            pred: the predictions from the inference</span>
<span class="sd">            volume: Volume containing the passive volume that was being predicted</span>

<span class="sd">        Returns:</span>
<span class="sd">            The reduced loss for the performance of the predictions</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">pass</span>

<div class="viewcode-block" id="AbsDetectorLoss.forward"><a class="viewcode-back" href="../../../../tomopt.optimisation.loss.html#tomopt.optimisation.loss.loss.AbsDetectorLoss.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="n">Volume</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the loss for the predictions of a single volume using the current state of the detector</span>

<span class="sd">        Arguments:</span>
<span class="sd">            pred: the predictions from the inference</span>
<span class="sd">            volume: Volume containing the passive volume that was being predicted and the detector being optimised</span>

<span class="sd">        Returns:</span>
<span class="sd">            The loss for the predictions and detector</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sub_losses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sub_losses</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inference_loss</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">volume</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sub_losses</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cost_loss</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_losses</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_losses</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_get_budget_coef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cost</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the budget loss term from the current cost of the detectors.</span>
<span class="sd">        Switch-on near target budget, plus linear/smooth increase above budget</span>

<span class="sd">        Arguments:</span>
<span class="sd">            cost: the current cost of the detector in currency units</span>

<span class="sd">        Returns:</span>
<span class="sd">            The budget loss component</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_budget</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cost</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steep_budget</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">budget_smoothing</span> <span class="o">*</span> <span class="p">(</span><span class="n">cost</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_budget</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_budget</span>
            <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">d</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">cost</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_budget</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">budget_smoothing</span> <span class="o">*</span> <span class="n">d</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_budget</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_budget</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_cost_coef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inference</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If the cost coefficient is None, will set it equal the current value of the inference-error loss</span>

<span class="sd">        Arguments:</span>
<span class="sd">            inference: the inference error component of the loss</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cost_coef</span> <span class="o">=</span> <span class="n">inference</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Automatically setting cost coefficient to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_coef</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_cost_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="n">Volume</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the budget term of the loss, dependent on the current cost of the detectors</span>

<span class="sd">        Arguments:</span>
<span class="sd">            volume: Volume containing the detectors being optimised</span>

<span class="sd">        Returns:</span>
<span class="sd">            The reduced loss term for the cost of the detectors</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_coef</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_cost_coef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_losses</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">])</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">get_cost</span><span class="p">()</span>
        <span class="n">cost_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_budget_coef</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_coef</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;cost </span><span class="si">{</span><span class="n">cost</span><span class="si">}</span><span class="s1">, cost coef </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_coef</span><span class="si">}</span><span class="s1">, budget coef </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_budget_coef</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span><span class="si">}</span><span class="s1">. error loss </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_losses</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">, cost loss </span><span class="si">{</span><span class="n">cost_loss</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">cost_loss</span></div>


<div class="viewcode-block" id="VoxelX0Loss"><a class="viewcode-back" href="../../../../tomopt.optimisation.loss.html#tomopt.optimisation.loss.loss.VoxelX0Loss">[docs]</a><span class="k">class</span> <span class="nc">VoxelX0Loss</span><span class="p">(</span><span class="n">AbsDetectorLoss</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loss function designed for tasks where the voxelwise X0 value must be predicted as floats.</span>
<span class="sd">    Inference-error component of the loss is the squared-error on X0 predictions, averaged over all voxels (MSE)</span>

<span class="sd">    The total loss consists of:</span>
<span class="sd">        - The MSE</span>
<span class="sd">        - An optional component that relates to the cost of the detector</span>
<span class="sd">    The total loss is the sum of these, with the cost-component being rescaled by a coefficient characterising its relative importance.</span>

<span class="sd">    The optional cost component is included as a budget weighting, which gradually increases with the current cost up to a predefined budget,</span>
<span class="sd">    after which it increases rapidly, but smoothly.</span>
<span class="sd">    Be default, the budget is based on a sigmoid centred at the budget, which linearly increases after the budget is exceeded.</span>
<span class="sd">    A less steep version is selectable, which flattens out slightly for high costs.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        target_budget: If not None, will include a cost component in the loss configured for the specified budget.</span>
<span class="sd">            Should be specified in the same currency units as the detector cost.</span>
<span class="sd">        budget_smoothing: controls how quickly the budget term rises with cost; lower values =&gt; slower rise</span>
<span class="sd">        cost_coef: Balancing coefficient used to multiply the budget term prior to its addition to the error component of the loss.</span>
<span class="sd">            If set to None, it will be set equal to the inference-error computed the first time the loss is computed</span>
<span class="sd">        steep_budget: If True, will use a linearly increasing budget term when the budget is exceeded,</span>
<span class="sd">            otherwise the budget term will flatten off for very high costs</span>
<span class="sd">        debug: If True, will print out information about the loss whenever it is evaluated</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_get_inference_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="n">Volume</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the MSE of the predictions against the true voxelwise X0s.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            pred: (z,x,y) voxelwise X0 predictions from the inference</span>
<span class="sd">            volume: Volume containing the passive volume that was being predicted</span>

<span class="sd">        Returns:</span>
<span class="sd">            The MSE for the predictions</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">true_x0</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">get_rad_cube</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">true_x0</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbsMaterialClassLoss"><a class="viewcode-back" href="../../../../tomopt.optimisation.loss.html#tomopt.optimisation.loss.loss.AbsMaterialClassLoss">[docs]</a><span class="k">class</span> <span class="nc">AbsMaterialClassLoss</span><span class="p">(</span><span class="n">AbsDetectorLoss</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for cases in which the task is to classify materials in the passive volumes, or some other aspect of the volumes.</span>
<span class="sd">    The targets returned by the volume are expected to be float X0s, and are converted to class IDs using an X0 to ID map.</span>

<span class="sd">    The loss consists of:</span>
<span class="sd">        - A component that quantifies the performance of the predictions made via the detectors</span>
<span class="sd">        - An optional component that relates to the cost of the detector</span>
<span class="sd">    The total loss is the sum of these, with the cost-component being rescaled by a coefficient characterising its relative importance.</span>

<span class="sd">    The performance component (error) should ideally be as close to the final task that the detector will be performing,</span>
<span class="sd">    and will depend on the output of the inference algorithm used</span>

<span class="sd">    The optional cost component is included as a budget weighting, which gradually increases with the current cost up to a predefined budget,</span>
<span class="sd">    after which it increases rapidly, but smoothly.</span>
<span class="sd">    Be default, the budget is based on a sigmoid centred at the budget, which linearly increases after the budget is exceeded.</span>
<span class="sd">    A less steep version is selectable, which flattens out slightly for high costs.</span>

<span class="sd">    Inheriting classes will need to at least override the `_get_inference_loss` method.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        x02id: Dictionary mapping float X0 targets to integer class IDs</span>
<span class="sd">        target_budget: If not None, will include a cost component in the loss configured for the specified budget.</span>
<span class="sd">            Should be specified in the same currency units as the detector cost.</span>
<span class="sd">        budget_smoothing: controls how quickly the budget term rises with cost; lower values =&gt; slower rise</span>
<span class="sd">        cost_coef: Balancing coefficient used to multiply the budget term prior to its addition to the error component of the loss.</span>
<span class="sd">            If set to None, it will be set equal to the inference-error computed the first time the loss is computed</span>
<span class="sd">        steep_budget: If True, will use a linearly increasing budget term when the budget is exceeded,</span>
<span class="sd">            otherwise the budget term will flatten off for very high costs</span>
<span class="sd">        debug: If True, will print out information about the loss whenever it is evaluated</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">x02id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">target_budget</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">budget_smoothing</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">cost_coef</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">steep_budget</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">target_budget</span><span class="o">=</span><span class="n">target_budget</span><span class="p">,</span> <span class="n">budget_smoothing</span><span class="o">=</span><span class="n">budget_smoothing</span><span class="p">,</span> <span class="n">cost_coef</span><span class="o">=</span><span class="n">cost_coef</span><span class="p">,</span> <span class="n">steep_budget</span><span class="o">=</span><span class="n">steep_budget</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x02id</span> <span class="o">=</span> <span class="n">x02id</span></div>


<div class="viewcode-block" id="VoxelClassLoss"><a class="viewcode-back" href="../../../../tomopt.optimisation.loss.html#tomopt.optimisation.loss.loss.VoxelClassLoss">[docs]</a><span class="k">class</span> <span class="nc">VoxelClassLoss</span><span class="p">(</span><span class="n">AbsMaterialClassLoss</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loss function designed for tasks where the voxelwise material class ID must be classified.</span>
<span class="sd">    Inference-error component of the loss is the negative log-likelihood on log class-probabilities, averaged over all voxels (NLL)</span>

<span class="sd">    Predictions should be provided as log-softmaxed class probabilities per voxel, with shape (1,classes,voxels).</span>
<span class="sd">    The ordering of the &quot;flattened&quot; voxels should match that of `volume.get_rad_cube().flatten()`</span>

<span class="sd">    The total loss consists of:</span>
<span class="sd">        - The NLL</span>
<span class="sd">        - An optional component that relates to the cost of the detector</span>
<span class="sd">    The total loss is the sum of these, with the cost-component being rescaled by a coefficient characterising its relative importance.</span>

<span class="sd">    The optional cost component is included as a budget weighting, which gradually increases with the current cost up to a predefined budget,</span>
<span class="sd">    after which it increases rapidly, but smoothly.</span>
<span class="sd">    Be default, the budget is based on a sigmoid centred at the budget, which linearly increases after the budget is exceeded.</span>
<span class="sd">    A less steep version is selectable, which flattens out slightly for high costs.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        x02id: Dictionary mapping float X0 targets to integer class IDs</span>
<span class="sd">        target_budget: If not None, will include a cost component in the loss configured for the specified budget.</span>
<span class="sd">            Should be specified in the same currency units as the detector cost.</span>
<span class="sd">        budget_smoothing: controls how quickly the budget term rises with cost; lower values =&gt; slower rise</span>
<span class="sd">        cost_coef: Balancing coefficient used to multiply the budget term prior to its addition to the error component of the loss.</span>
<span class="sd">            If set to None, it will be set equal to the inference-error computed the first time the loss is computed</span>
<span class="sd">        steep_budget: If True, will use a linearly increasing budget term when the budget is exceeded,</span>
<span class="sd">            otherwise the budget term will flatten off for very high costs</span>
<span class="sd">        debug: If True, will print out information about the loss whenever it is evaluated</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_get_inference_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="n">Volume</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the NLL of the log-probabilities against the true voxelwise classes.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            pred: (1,classes,voxels) log probabilities for voxel class IDs</span>
<span class="sd">            volume: Volume containing the passive volume that was being predicted</span>

<span class="sd">        Returns:</span>
<span class="sd">            The mean NLL for the predictions</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">true_x0</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">get_rad_cube</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">x0</span> <span class="ow">in</span> <span class="n">true_x0</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">true_x0</span><span class="p">[</span><span class="n">true_x0</span> <span class="o">==</span> <span class="n">x0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x02id</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x02id</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">))]</span>
        <span class="n">true_x0</span> <span class="o">=</span> <span class="n">true_x0</span><span class="o">.</span><span class="n">long</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">true_x0</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="VolumeClassLoss"><a class="viewcode-back" href="../../../../tomopt.optimisation.loss.html#tomopt.optimisation.loss.loss.VolumeClassLoss">[docs]</a><span class="k">class</span> <span class="nc">VolumeClassLoss</span><span class="p">(</span><span class="n">AbsMaterialClassLoss</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loss function designed for tasks where some overall target of the passive volume must be classified, and the target of the volume is encoded as a float X0.</span>
<span class="sd">    E.g. what is the material of a large block in the volume.</span>

<span class="sd">    The Inference-error component of the loss depends on shape of predictions provided:</span>
<span class="sd">        If the predictions are of shape (1,classes,voxels), they will be interpreted as multi-class log-probabilities and the negative log-likelihood computed</span>
<span class="sd">        If the predictions are of shape (1,1,voxels), they will be interpreted as binary class probabilities and the binary cross-entropy computed</span>

<span class="sd">    The ordering of the &quot;flattened&quot; voxels should match that of `volume.get_rad_cube().flatten()`</span>

<span class="sd">    The total loss consists of:</span>
<span class="sd">        - The NLL or BCE</span>
<span class="sd">        - An optional component that relates to the cost of the detector</span>
<span class="sd">    The total loss is the sum of these, with the cost-component being rescaled by a coefficient characterising its relative importance.</span>

<span class="sd">    The optional cost component is included as a budget weighting, which gradually increases with the current cost up to a predefined budget,</span>
<span class="sd">    after which it increases rapidly, but smoothly.</span>
<span class="sd">    Be default, the budget is based on a sigmoid centred at the budget, which linearly increases after the budget is exceeded.</span>
<span class="sd">    A less steep version is selectable, which flattens out slightly for high costs.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        x02id: Dictionary mapping float X0 targets to integer class IDs</span>
<span class="sd">        target_budget: If not None, will include a cost component in the loss configured for the specified budget.</span>
<span class="sd">            Should be specified in the same currency units as the detector cost.</span>
<span class="sd">        budget_smoothing: controls how quickly the budget term rises with cost; lower values =&gt; slower rise</span>
<span class="sd">        cost_coef: Balancing coefficient used to multiply the budget term prior to its addition to the error component of the loss.</span>
<span class="sd">            If set to None, it will be set equal to the inference-error computed the first time the loss is computed</span>
<span class="sd">        steep_budget: If True, will use a linearly increasing budget term when the budget is exceeded,</span>
<span class="sd">            otherwise the budget term will flatten off for very high costs</span>
<span class="sd">        debug: If True, will print out information about the loss whenever it is evaluated</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_get_inference_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="n">Volume</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the NLL of the log-probabilities against the true voxelwise classes.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            pred: (1,classes,voxels) log probabilities for voxel class IDs, or (1,1,voxels) probabilities for voxels being of class 1</span>
<span class="sd">            volume: Volume containing the passive volume that was being predicted</span>

<span class="sd">        Returns:</span>
<span class="sd">            The mean NLL|BCE for the predictions</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">targ</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">x0</span> <span class="ow">in</span> <span class="n">targ</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">targ</span><span class="p">[</span><span class="n">targ</span> <span class="o">==</span> <span class="n">x0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x02id</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x02id</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">))]</span>
        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">targ</span><span class="o">.</span><span class="n">long</span><span class="p">(),</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">targ</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="VolumeIntClassLoss"><a class="viewcode-back" href="../../../../tomopt.optimisation.loss.html#tomopt.optimisation.loss.loss.VolumeIntClassLoss">[docs]</a><span class="k">class</span> <span class="nc">VolumeIntClassLoss</span><span class="p">(</span><span class="n">AbsDetectorLoss</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loss function designed for tasks where some overall integer target of the passive volume must be classified,</span>
<span class="sd">    and the values of this target are quantifiably comparable (i.e. the integers are treatable as numbers not just categorical codes).</span>
<span class="sd">    E.g. Predicting how many layers of the passive volume are filled with a given material.</span>

<span class="sd">    The Inference-error component of the loss computed as the :meth:`~tomopt.optimisation.loss.sub_losses.integer_class_loss`.</span>
<span class="sd">    Predictions should be provided as probabilities for every possible integer target</span>
<span class="sd">    The target from the volume can be converted to an integer (e.g. height to layer ID) using a `targ2int` function</span>

<span class="sd">    The total loss consists of:</span>
<span class="sd">        - The integer class loss (ICL)</span>
<span class="sd">        - An optional component that relates to the cost of the detector</span>
<span class="sd">    The total loss is the sum of these, with the cost-component being rescaled by a coefficient characterising its relative importance.</span>

<span class="sd">    The optional cost component is included as a budget weighting, which gradually increases with the current cost up to a predefined budget,</span>
<span class="sd">    after which it increases rapidly, but smoothly.</span>
<span class="sd">    Be default, the budget is based on a sigmoid centred at the budget, which linearly increases after the budget is exceeded.</span>
<span class="sd">    A less steep version is selectable, which flattens out slightly for high costs.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        target_budget: If not None, will include a cost component in the loss configured for the specified budget.</span>
<span class="sd">            Should be specified in the same currency units as the detector cost.</span>
<span class="sd">        budget_smoothing: controls how quickly the budget term rises with cost; lower values =&gt; slower rise</span>
<span class="sd">        cost_coef: Balancing coefficient used to multiply the budget term prior to its addition to the error component of the loss.</span>
<span class="sd">            If set to None, it will be set equal to the inference-error computed the first time the loss is computed</span>
<span class="sd">        steep_budget: If True, will use a linearly increasing budget term when the budget is exceeded,</span>
<span class="sd">            otherwise the budget term will flatten off for very high costs</span>
<span class="sd">        debug: If True, will print out information about the loss whenever it is evaluated</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">targ2int</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Volume</span><span class="p">],</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="n">pred_int_start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">use_mse</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">target_budget</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">budget_smoothing</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">cost_coef</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">steep_budget</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Arguments:</span>
<span class="sd">            targ2int: function to convert volume targets to integers to classify</span>
<span class="sd">            pred_int_start: the integer that the zeroth probability in predictions corresponds to</span>
<span class="sd">            use_mse: passed to :meth:`~tomopt.optimisation.loss.sub_losses.integer_class_loss`</span>
<span class="sd">            target_budget: If not None, will include a cost component in the loss configured for the specified budget.</span>
<span class="sd">                Should be specified in the same currency units as the detector cost.</span>
<span class="sd">            budget_smoothing: controls how quickly the budget term rises with cost; lower values =&gt; slower rise</span>
<span class="sd">            cost_coef: Balancing coefficient used to multiply the budget term prior to its addition to the error component of the loss.</span>
<span class="sd">                If set to None, it will be set equal to the inference-error computed the first time the loss is computed</span>
<span class="sd">            steep_budget: If True, will use a linearly increasing budget term when the budget is exceeded,</span>
<span class="sd">                otherwise the budget term will flatten off for very high costs</span>
<span class="sd">            debug: If True, will print out information about the loss whenever it is evaluated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">target_budget</span><span class="o">=</span><span class="n">target_budget</span><span class="p">,</span> <span class="n">budget_smoothing</span><span class="o">=</span><span class="n">budget_smoothing</span><span class="p">,</span> <span class="n">cost_coef</span><span class="o">=</span><span class="n">cost_coef</span><span class="p">,</span> <span class="n">steep_budget</span><span class="o">=</span><span class="n">steep_budget</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targ2int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_int_start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_mse</span> <span class="o">=</span> <span class="n">targ2int</span><span class="p">,</span> <span class="n">pred_int_start</span><span class="p">,</span> <span class="n">use_mse</span>

    <span class="k">def</span> <span class="nf">_get_inference_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="n">Volume</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the ICL of the integer probabilities against the true target integer.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            pred: (1,*,integers) integer probabilities</span>
<span class="sd">            volume: Volume containing the passive volume that was being predicted</span>

<span class="sd">        Returns:</span>
<span class="sd">            The mean ICL for the predictions</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">int_targ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">targ2int</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="n">volume</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">integer_class_loss</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">int_targ</span><span class="p">,</span> <span class="n">pred_start_int</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_int_start</span><span class="p">,</span> <span class="n">use_mse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_mse</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="VolumeMSELoss"><a class="viewcode-back" href="../../../../tomopt.optimisation.loss.html#tomopt.optimisation.loss.loss.VolumeMSELoss">[docs]</a><span class="k">class</span> <span class="nc">VolumeMSELoss</span><span class="p">(</span><span class="n">AbsDetectorLoss</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO: Add unit tests and docs</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_get_inference_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="n">Volume</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the MSE of the preds and targets.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            pred: predicted floats</span>
<span class="sd">            volume: Volume containing the passive volume that was being predicted</span>

<span class="sd">        Returns:</span>
<span class="sd">            The mean MSE for the predictions</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">targ</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">targ</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span></div>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  <hr>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021-2024, TomOpt Authors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/GilesStrong/tomopt_sphinx_theme">theme</a> based on a <a href="https://github.com/pytorch/pytorch_sphinx_theme">theme</a> provided by <a href="https://pytorch.org/">PyTorch</a> based on a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
         <script src="../../../../_static/doctools.js"></script>
         <script src="../../../../_static/sphinx_highlight.js"></script>
     

  

  <script type="text/javascript" src="../../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/vendor/bootstrap.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-6 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer and user documentation for TomOpt</p>
          <a class="with-right-arrow" href="https://tomopt.readthedocs.io/en/stable">View Docs</a>
        </div>

        <div class="col-md-6 text-center">
          <h2>Tutorials</h2>
          <p>Get tutorials for beginner and advanced researchers demonstrating many of the features of TomOpt</p>
          <a class="with-right-arrow" href="https://github.com/GilesStrong/mode_muon_tomography#examples">View Tutorials</a>
        </div>

        <!-- <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="">View Resources</a>
        </div> -->
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://tomopt.readthedocs.io/en/stable" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <!-- <li class="list-title"><a href="https://tomopt.readthedocs.io/en/stable">TomOpt</a></li> -->
            <!-- <li><a href="">Get Started</a></li> -->
            <!-- <li><a href="">Features</a></li> -->
            <!-- <li><a href="">Ecosystem</a></li> -->
            <!-- <li><a href="">Blog</a></li> -->
            <!-- <li><a href="">Resources</a></li> -->
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="">Support</a></li>
            <li><a href="https://github.com/GilesStrong/mode_muon_tomography#examples">Tutorials</a></li>
            <li><a href="https://tomopt.readthedocs.io/en/stable">Docs</a></li>
            <!-- <li><a href="" target="_blank">Discuss</a></li> -->
            <li><a href="https://github.com/GilesStrong/mode_muon_tomography/blob/main/CHANGES.md" target="_blank">Change Log</a></li>
            <li><a href="https://github.com/GilesStrong/mode_muon_tomography/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://github.com/GilesStrong/mode_muon_tomography/blob/main/CITATION.md" target="_blank">Citation</a></li>
            <!-- <li><a href="" target="_blank">Slack</a></li> -->
            <!-- <li><a href="https://github.com/GilesStrong/mode_muon_tomography/blob/main/CONTRIBUTING.md" target="_blank">Contributing</a></li> -->
          </ul>
        </div>

        <!-- <div class="footer-links-col follow-us-col">
          <ul>
            <li class="list-title">Follow Us</li>
            <li>
              <div id="mc_embed_signup">
                <form
                  action="https://twitter.us14.list-manage.com/subscribe/post?u=75419c71fe0a935e53dfa4a3f&id=91d0dccd39"
                  method="post"
                  id="mc-embedded-subscribe-form"
                  name="mc-embedded-subscribe-form"
                  class="email-subscribe-form validate"
                  target="_blank"
                  novalidate>
                  <div id="mc_embed_signup_scroll" class="email-subscribe-form-fields-wrapper">
                    <div class="mc-field-group">
                      <label for="mce-EMAIL" style="display:none;">Email Address</label>
                      <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address">
                    </div>

                    <div id="mce-responses" class="clear">
                      <div class="response" id="mce-error-response" style="display:none"></div>
                      <div class="response" id="mce-success-response" style="display:none"></div>
                    </div>    real people should not fill this in and expect good things - do not remove this or risk form bot signups

                    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_75419c71fe0a935e53dfa4a3f_91d0dccd39" tabindex="-1" value=""></div>

                    <div class="clear">
                      <input type="submit" value="" name="subscribe" id="mc-embedded-subscribe" class="button email-subscribe-button">
                    </div>
                  </div>
                </form>
              </div>

            </li>
          </ul>

          <div class="footer-social-icons">
            <a href="" target="_blank" class="facebook"></a>
            <a href="" target="_blank" class="twitter"></a>
          </div>
        </div> -->
      </div>
    </div>
  </footer>

  <!-- <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebooks Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../../_static/images/pytorch-x.svg">
  </div>
</div> -->

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://tomopt.readthedocs.io/en/stable" aria-label="TomOpt"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <!-- <li>
            <a href="#">Get Started</a>
          </li> -->

          <!-- <li>
            <a href="#">Features</a>
          </li> -->

          <!-- <li>
            <a href="#">Ecosystem</a>
          </li> -->

          <!-- <li>
            <a href="">Blog</a>
          </li> -->

          <li>
            <a href="https://github.com/GilesStrong/mode_muon_tomography#examples">Tutorials</a>
          </li>

          <li>
            <a href="https://tomopt.readthedocs.io/en/stable">Docs</a>
          </li>

          <!-- <li>
            <a href="">Resources</a>
          </li> -->

          <li>
            <a href="https://github.com/GilesStrong/mode_muon_tomography">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>