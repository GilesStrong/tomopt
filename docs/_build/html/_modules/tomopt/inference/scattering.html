


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>tomopt.inference.scattering &mdash; TomOpt  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/tomopt_logo.png"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://tomopt.readthedocs.io/en/stable" aria-label="TomOpt"></a>

      <div class="main-menu">
        <ul>
          <!-- <li>
            <a href="">Get Started</a>
          </li> -->

          <!-- <li>
            <a href="">Features</a>
          </li> -->

          <!-- <li>
            <a href="">Ecosystem</a>
          </li> -->

          <!-- <li>
            <a href="">Blog</a>
          </li> -->

          <li>
            <a href="https://github.com/GilesStrong/mode_muon_tomography#examples">Tutorials</a>
          </li>

          <li>
            <a href="https://tomopt.readthedocs.io/en/stable">Docs</a>
          </li>

          <!-- <li>
            <a href="">Resources</a>
          </li> -->

          <li>
            <a href="https://github.com/GilesStrong/mode_muon_tomography">Github</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>

  </div>
</div>


<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html#testing">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html#external-repos">External repos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html#authors">Authors</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tomopt.html">tomopt package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tomopt.muon.html">tomopt.muon package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tomopt.volume.html">tomopt.volume package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tomopt.inference.html">tomopt.inference package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tomopt.optimisation.html">tomopt.optimisation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tomopt.plotting.html">tomopt.plotting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tomopt.benchmarks.html">tomopt.benchmarks package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../index.html">Module code</a> &gt;</li>
        
      <li>tomopt.inference.scattering</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for tomopt.inference.scattering</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">Tensor</span>

<span class="kn">from</span> <span class="nn">..muon</span> <span class="kn">import</span> <span class="n">MuonBatch</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">jacobian</span>
<span class="kn">from</span> <span class="nn">..volume</span> <span class="kn">import</span> <span class="n">Volume</span>

<span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Provides implementations of inference algorithms designed to extract variables related to muon scattering from the hits recorded by the detectors</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ScatterBatch&quot;</span><span class="p">,</span> <span class="s2">&quot;GenScatterBatch&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="ScatterBatch"><a class="viewcode-back" href="../../../tomopt.inference.html#tomopt.inference.scattering.ScatterBatch">[docs]</a><span class="k">class</span> <span class="nc">ScatterBatch</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for computing scattering information from the hits via incoming/outgoing trajectory fitting.</span>

<span class="sd">    Linear fits are performed separately to all hits associated with layer groups, as indicated by the `pos` attribute of the layers which recorded hits.</span>
<span class="sd">    Currently, the inference methods expect detectors above the passive layer to have `pos==&#39;above&#39;`,</span>
<span class="sd">    and those below the passive volume to have `pos==&#39;below&#39;`.</span>
<span class="sd">    Trajectory fitting is performed using an analytic likelihood minimisation, which considers uncertainties and efficiencies on the hits in x and y.</span>

<span class="sd">    .. important::</span>
<span class="sd">        The current separation of hits into above and below groups does not allow for e.g. a third set of detectors,</span>
<span class="sd">        since this split is based on the value of the `n_hits_above` attribute.</span>

<span class="sd">    One instance of this class should created for each :class:`~tomopt.muon.muon_batch.MuonBatch`.</span>
<span class="sd">    As part of the initialisation, muons will be filtered using :meth:`~tomopt.inference.ScatterBatch._filter_scatters`</span>
<span class="sd">    in order to avoid NaN/Inf gradients or values. This results in direct, in-place changes to the :class:`~tomopt.muon.muon_batch.MuonBatch`.</span>

<span class="sd">    Since many variables of the scattering can be inferred, but not all are required for further inference downstream,</span>
<span class="sd">    variables, and their uncertainties, are computed on a lazy basis, with memoisation: the values are only computed on the first request (if at all)</span>
<span class="sd">    and then stored in case of further requests.</span>

<span class="sd">    The dtheta, dphi, and total scattering variables are computed under the assumption of small angular scatterings.</span>
<span class="sd">    An assumption is necessary here, since there is a loss of information in the when the muons undergo scattering in theta and phi:</span>
<span class="sd">    since theta is [0,pi] a negative scattering in theta will always results in a positive theta, but phi can become phi+pi.</span>
<span class="sd">    When inferring the angular scattering, one cannot precisely tell whether instead a large scattering in phi occurred.</span>
<span class="sd">    The total scattering (`total_scatter`) is the quadrature sum of dtheta and dphi, and all three are computed under both hypotheses.</span>
<span class="sd">    The final values of these are chosen using the hypothesis which minimises the total amount of scattering.</span>
<span class="sd">    This assumption has been tested and found to be good.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        mu: muons with hits to infer on</span>
<span class="sd">        volume: volume through which the muons travelled</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Hits</span>
    <span class="n">_reco_hits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,hits,xyz) recorded hits with finite xy resolution</span>
    <span class="n">_gen_hits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,hits,xyz) true positions of the muons</span>
    <span class="n">_hit_uncs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,hits,xyz) uncertainty on the hits due to resolution</span>
    <span class="n">_hit_effs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,hits,eff) efficiencies of the hits</span>

    <span class="c1"># Tracks</span>
    <span class="n">_track_in</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,xyz) incoming xyz vector</span>
    <span class="n">_track_out</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,xyz) outgoing xyz vector</span>
    <span class="n">_track_start_in</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,xyz) xyz location of initial point along incoming vector</span>
    <span class="n">_track_start_out</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,xyz) xyz location of initial point along outgoing vector</span>
    <span class="n">_cross_track</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,xyz) vector normal to both incoming and outgoing vectors</span>
    <span class="n">_track_coefs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,xyz) distances along incoming, cross, and outgoing vectors to intersection points</span>

    <span class="c1"># Inferred variables</span>
    <span class="n">_poca_xyz</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,xyz) xyz location of PoCA</span>
    <span class="n">_poca_xyz_unc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_theta_in</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,1) theta of incoming muons</span>
    <span class="n">_theta_in_unc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_theta_out</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,1) theta of outgoing muons</span>
    <span class="n">_theta_out_unc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_dtheta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,1) delta theta between incoming &amp; outgoing muons</span>
    <span class="n">_dtheta_unc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_phi_in</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,1) phi of incoming muons</span>
    <span class="n">_phi_in_unc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_phi_out</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,1) phi of outgoing muons</span>
    <span class="n">_phi_out_unc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_dphi</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,1) delta phi between incoming &amp; outgoing muons</span>
    <span class="n">_dphi_unc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_total_scatter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,1) quadrature sum of dtheta and dphi</span>
    <span class="n">_total_scatter_unc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_theta_xy_in</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,xy) decomposed theta and phi of incoming muons in the zx and zy planes</span>
    <span class="n">_theta_xy_in_unc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_theta_xy_out</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,xy) decomposed theta and phi of outgoing muons in the zx and zy planes</span>
    <span class="n">_theta_xy_out_unc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_dtheta_xy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,xy) delta theta_xy between incoming &amp; outgoing muons in the zx and zy planes</span>
    <span class="n">_dtheta_xy_unc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_xyz_in</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,xyz) inferred xy position of muon at the z-level of the top of the passive volume</span>
    <span class="n">_xyz_in_unc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_xyz_out</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,xyz) inferred xy position of muon at the z-level of the bottom of the passive volume</span>
    <span class="n">_xyz_out_unc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_dxy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (muons,xy) distances in x &amp; y from PoCA to incoming|outgoing muons</span>
    <span class="n">_dxy_unc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="n">MuonBatch</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="n">Volume</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise scatter batch from a muon batch.</span>
<span class="sd">        During initialisation:</span>
<span class="sd">            The muons will be filtered in-place via :meth:`~tomopt.inference.ScatterBatch._filter_scatters`</span>
<span class="sd">            The trajectories for the incoming and outgoing muons will be fitted.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">mu</span><span class="p">,</span> <span class="n">volume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">get_hits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_scatters</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">)</span>

<div class="viewcode-block" id="ScatterBatch.get_muon_trajectory"><a class="viewcode-back" href="../../../tomopt.inference.html#tomopt.inference.scattering.ScatterBatch.get_muon_trajectory">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_muon_trajectory</span><span class="p">(</span><span class="n">hits</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">uncs</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">lw</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fits a linear trajectory to a group of hits, whilst considering their uncertainties on their xy positions.</span>
<span class="sd">        No uncertainty is considered for z positions of hits.</span>
<span class="sd">        The fit is performed via an analytical likelihood-maximisation.</span>


<span class="sd">        .. important::</span>
<span class="sd">            Muons with &lt;2 hits have NaN trajectory</span>

<span class="sd">        Arguments:</span>
<span class="sd">            hits: (muons,hits,xyz) tensor of hit positions</span>
<span class="sd">            uncs: (muons,hits,(unc x,unc y,0)) tensor of hit uncertainties</span>
<span class="sd">            lw: length and width of the passive layers of the volume</span>

<span class="sd">        Returns:</span>
<span class="sd">            vec: (muons,xyz) fitted-vector directions</span>
<span class="sd">            start: (muons,xyz) initial point of fitted-vector</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">hits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">hits</span><span class="p">),</span> <span class="n">lw</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">hits</span><span class="o">.</span><span class="n">type</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hits</span><span class="p">)</span>
        <span class="n">uncs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">uncs</span><span class="p">)</span>  <span class="c1"># Set Infs to large number</span>

        <span class="n">stars</span><span class="p">,</span> <span class="n">angles</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>  <span class="c1"># separate x and y resolutions</span>
            <span class="n">inv_unc2</span> <span class="o">=</span> <span class="n">uncs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="o">-</span><span class="mi">2</span>
            <span class="n">sum_inv_unc2</span> <span class="o">=</span> <span class="n">inv_unc2</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">mean_xz</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hits</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">*</span> <span class="n">inv_unc2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_inv_unc2</span>
            <span class="n">mean_xz_z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hits</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">*</span> <span class="n">hits</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">inv_unc2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_inv_unc2</span>
            <span class="n">mean_x</span> <span class="o">=</span> <span class="n">mean_xz</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">mean_z</span> <span class="o">=</span> <span class="n">mean_xz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="n">mean_x_z</span> <span class="o">=</span> <span class="n">mean_xz_z</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">mean_z2</span> <span class="o">=</span> <span class="n">mean_xz_z</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>

            <span class="n">stars</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">mean_x</span> <span class="o">-</span> <span class="p">((</span><span class="n">mean_z</span> <span class="o">*</span> <span class="n">mean_x_z</span><span class="p">)</span> <span class="o">/</span> <span class="n">mean_z2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">mean_z</span><span class="o">.</span><span class="n">square</span><span class="p">()</span> <span class="o">/</span> <span class="n">mean_z2</span><span class="p">)))</span>
            <span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">mean_x_z</span> <span class="o">-</span> <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">mean_z</span><span class="p">))</span> <span class="o">/</span> <span class="n">mean_z2</span><span class="p">)</span>

        <span class="n">xy_star</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_calc_xyz</span><span class="p">(</span><span class="n">z</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">xy_star</span> <span class="o">+</span> <span class="p">(</span><span class="n">angle</span> <span class="o">*</span> <span class="n">z</span><span class="p">),</span> <span class="n">z</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">_calc_xyz</span><span class="p">(</span><span class="n">hits</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># Upper &amp; lower hits. Only z coord is used therefore ok if xy were NaN/Inf</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">_calc_xyz</span><span class="p">(</span><span class="n">hits</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>

        <span class="k">return</span> <span class="n">vec</span><span class="p">,</span> <span class="n">start</span></div>

<div class="viewcode-block" id="ScatterBatch.get_scatter_mask"><a class="viewcode-back" href="../../../tomopt.inference.html#tomopt.inference.scattering.ScatterBatch.get_scatter_mask">[docs]</a>    <span class="k">def</span> <span class="nf">get_scatter_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons) Boolean tensor where True indicates that the PoCA of the muon is located within the passive volume</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">get_passive_z_range</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poca_xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poca_xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">lw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poca_xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poca_xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">lw</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poca_xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poca_xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ScatterBatch.plot_scatter"><a class="viewcode-back" href="../../../tomopt.inference.html#tomopt.inference.scattering.ScatterBatch.plot_scatter">[docs]</a>    <span class="k">def</span> <span class="nf">plot_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">savename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots representation of hits and fitted trajectories for a single muon.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            idx: index of muon to plot</span>
<span class="sd">            savename: optional path to save figure to</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">xin</span><span class="p">,</span> <span class="n">xout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;above&quot;</span><span class="p">][</span><span class="s2">&quot;reco_xyz&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;below&quot;</span><span class="p">][</span><span class="s2">&quot;reco_xyz&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">yin</span><span class="p">,</span> <span class="n">yout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;above&quot;</span><span class="p">][</span><span class="s2">&quot;reco_xyz&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;below&quot;</span><span class="p">][</span><span class="s2">&quot;reco_xyz&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">zin</span><span class="p">,</span> <span class="n">zout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;above&quot;</span><span class="p">][</span><span class="s2">&quot;reco_xyz&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;below&quot;</span><span class="p">][</span><span class="s2">&quot;reco_xyz&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">xin_unc</span><span class="p">,</span> <span class="n">xout_unc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;above&quot;</span><span class="p">][</span><span class="s2">&quot;unc_xyz&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;below&quot;</span><span class="p">][</span><span class="s2">&quot;unc_xyz&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">yin_unc</span><span class="p">,</span> <span class="n">yout_unc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;above&quot;</span><span class="p">][</span><span class="s2">&quot;unc_xyz&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;below&quot;</span><span class="p">][</span><span class="s2">&quot;unc_xyz&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poca_xyz</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">scatter_unc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poca_xyz_unc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="n">dtheta_xy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtheta_xy</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">dphi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphi</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">phi_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_in</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">phi_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_out</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">theta_xy_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_xy_in</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">theta_xy_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_xy_out</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">track_start_in</span><span class="p">,</span> <span class="n">track_start_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_start_in</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_start_out</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">track_in</span><span class="p">,</span> <span class="n">track_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_in</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_out</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">track_start_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">zin</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">track_start_in</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">track_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">track_in</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="n">track_start_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">zout</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">track_start_in</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">track_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">track_in</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
            <span class="p">],</span>
            <span class="p">[</span><span class="n">zin</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">zout</span><span class="o">.</span><span class="n">min</span><span class="p">()],</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\theta_{x,in}=&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">theta_xy_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">track_start_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">zin</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">track_start_out</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">track_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">track_out</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="n">track_start_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">zout</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">track_start_out</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">track_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">track_out</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
            <span class="p">],</span>
            <span class="p">[</span><span class="n">zin</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">zout</span><span class="o">.</span><span class="n">min</span><span class="p">()],</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\theta_{x,out}=&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">theta_xy_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xin</span><span class="p">,</span> <span class="n">zin</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xout</span><span class="p">,</span> <span class="n">zout</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">scatter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scatter</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\Delta\theta_x=&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dtheta_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.1e</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xin</span><span class="p">,</span> <span class="n">zin</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">xin_unc</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xout</span><span class="p">,</span> <span class="n">zout</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">xout_unc</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scatter</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">xerr</span><span class="o">=</span><span class="n">scatter_unc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">scatter_unc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">track_start_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">zin</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">track_start_in</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">track_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">track_in</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="n">track_start_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">zout</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">track_start_in</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">track_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">track_in</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
            <span class="p">],</span>
            <span class="p">[</span><span class="n">zin</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">zout</span><span class="o">.</span><span class="n">min</span><span class="p">()],</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\theta_{y,in}=&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">theta_xy_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">track_start_out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">zin</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">track_start_out</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">track_out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">track_out</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="n">track_start_out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">zout</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">track_start_out</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">track_out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">track_out</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
            <span class="p">],</span>
            <span class="p">[</span><span class="n">zin</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">zout</span><span class="o">.</span><span class="n">min</span><span class="p">()],</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\theta_{y,out}=&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">theta_xy_out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">yin</span><span class="p">,</span> <span class="n">zin</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">yout</span><span class="p">,</span> <span class="n">zout</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">scatter</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">scatter</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\Delta\theta_y=&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dtheta_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.1e</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">yin</span><span class="p">,</span> <span class="n">zin</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">yin_unc</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">yout</span><span class="p">,</span> <span class="n">zout</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">yout_unc</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">scatter</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">xerr</span><span class="o">=</span><span class="n">scatter_unc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">scatter_unc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">track_start_in</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">track_start_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi_in</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">],</span>
            <span class="p">[</span><span class="n">track_start_in</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">track_start_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi_in</span><span class="p">)[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\phi_</span><span class="si">{in}</span><span class="s2">=&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phi_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">track_start_out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">track_start_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi_out</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">],</span>
            <span class="p">[</span><span class="n">track_start_out</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">track_start_out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi_out</span><span class="p">)[</span><span class="mi">0</span><span class="p">]],</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\phi_</span><span class="si">{out}</span><span class="s2">=&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phi_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xin</span><span class="p">,</span> <span class="n">yin</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xout</span><span class="p">,</span> <span class="n">yout</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">scatter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scatter</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\Delta\phi=&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dphi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.1e</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xin</span><span class="p">,</span> <span class="n">yin</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">xin_unc</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">yin_unc</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xout</span><span class="p">,</span> <span class="n">yout</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">xout_unc</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">yout_unc</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scatter</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xerr</span><span class="o">=</span><span class="n">scatter_unc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">scatter_unc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">savename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savename</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_compute_theta_msc</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">q</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the angle between sets of vectors p and q via the cosine dot-product.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            p: (N,xyz) vectors 1</span>
<span class="sd">            q: (N,xyz) vectors 2</span>

<span class="sd">        Returns:</span>
<span class="sd">           (N,1) angles between vectors</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">arccos</span><span class="p">((</span><span class="n">p</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_compute_theta</span><span class="p">(</span><span class="n">track</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the theta angles of vectors</span>

<span class="sd">        Arguments:</span>
<span class="sd">            track: (N,xyz) components of the vectors</span>

<span class="sd">        Returns:</span>
<span class="sd">            (N,1) theta angles of the vectors</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">arg</span> <span class="o">=</span> <span class="o">-</span><span class="n">track</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">track</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">!=</span> <span class="mi">1</span>
        <span class="n">theta</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">theta</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_compute_phi</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the phi angles from the xy components of vectors</span>

<span class="sd">        Arguments:</span>
<span class="sd">            x: (N,1) x components of the vectors</span>
<span class="sd">            y: (N,1) y components of the vectors</span>

<span class="sd">        Returns:</span>
<span class="sd">            (N,1) phi angles of the vectors</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">phi</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Case when x == 0</span>
        <span class="n">phi</span><span class="p">[(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">phi</span><span class="p">[(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">phi</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
        <span class="c1"># # Account for quadrants</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="n">phi</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">phi</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>  <span class="c1"># (0, 2pi)</span>

        <span class="k">return</span> <span class="n">phi</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_compute_dtheta_dphi_scatter</span><span class="p">(</span><span class="n">theta_in</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">phi_in</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">theta_out</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">phi_out</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes dtheta and dphi variables under the assumption of small angular scatterings.</span>
<span class="sd">        An assumption is necessary here, since there is a loss of information in the when the muons undergo scattering in theta and phi:</span>
<span class="sd">        since theta is [0,pi] a negative scattering in theta will always results in a positive theta, but phi can become phi+pi.</span>
<span class="sd">        When inferring the angular scattering, one cannot precisely tell whether instead a large scattering in phi occurred.</span>
<span class="sd">        The total scattering (`total_scatter`) is the quadrature sum of dtheta and dphi, and all three are computed under both hypotheses.</span>
<span class="sd">        The final values of these are chosen using the hypothesis which minimises the total amount of scattering.</span>
<span class="sd">        This assumption has been tested and found to be good.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            theta_in: (N,1) theta angle of incoming muons</span>
<span class="sd">            phi_in: (N,1) phi angle of incoming muons</span>
<span class="sd">            theta_out: (N,1) theta angle of outgoing muons</span>
<span class="sd">            phi_out: (N,1) phi angle of outgoing muons</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of (N,1) tensors for &quot;dtheta&quot;, &quot;dphi&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">theta_in</span> <span class="o">=</span> <span class="n">theta_in</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">phi_in</span> <span class="o">=</span> <span class="n">phi_in</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">theta_out</span> <span class="o">=</span> <span class="n">theta_out</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">phi_out</span> <span class="o">=</span> <span class="n">phi_out</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">dtheta</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([(</span><span class="n">theta_in</span> <span class="o">-</span> <span class="n">theta_out</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">(),</span> <span class="n">theta_in</span> <span class="o">+</span> <span class="n">theta_out</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dphi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">phi_in</span><span class="p">)</span> <span class="o">+</span> <span class="n">phi_out</span><span class="p">,</span>
                    <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">phi_out</span><span class="p">)</span> <span class="o">+</span> <span class="n">phi_in</span><span class="p">,</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">phi_in</span> <span class="o">-</span> <span class="n">phi_out</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="n">dphi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">dphi</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">dphi</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">total_scatter</span> <span class="o">=</span> <span class="p">(</span><span class="n">dtheta</span><span class="o">.</span><span class="n">square</span><span class="p">()</span> <span class="o">+</span> <span class="n">dphi</span><span class="o">.</span><span class="n">square</span><span class="p">())</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="c1"># Pick set with smallest scattering</span>
        <span class="n">hypo</span> <span class="o">=</span> <span class="n">total_scatter</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">total_scatter</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;dtheta&quot;</span><span class="p">:</span> <span class="n">dtheta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">hypo</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="s2">&quot;dphi&quot;</span><span class="p">:</span> <span class="n">dphi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">hypo</span><span class="p">,</span> <span class="kc">None</span><span class="p">]}</span>

    <span class="k">def</span> <span class="nf">_extract_hits</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes the dictionary of hits from the muons and combines them into single tensors of recorded and true hits.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_n_hits_above</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;above&quot;</span><span class="p">][</span><span class="s2">&quot;reco_xyz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_hits_below</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;below&quot;</span><span class="p">][</span><span class="s2">&quot;reco_xyz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Combine all input vars into single tensor, NB ideally would stack to new dim but can&#39;t assume same number of panels above &amp; below</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reco_hits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;above&quot;</span><span class="p">][</span><span class="s2">&quot;reco_xyz&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;below&quot;</span><span class="p">][</span><span class="s2">&quot;reco_xyz&quot;</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># muons, all panels, reco xyz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gen_hits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;above&quot;</span><span class="p">][</span><span class="s2">&quot;gen_xyz&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;below&quot;</span><span class="p">][</span><span class="s2">&quot;gen_xyz&quot;</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># muons, all panels, true xyz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hit_uncs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;above&quot;</span><span class="p">][</span><span class="s2">&quot;unc_xyz&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;below&quot;</span><span class="p">][</span><span class="s2">&quot;unc_xyz&quot;</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># muons, all panels, xyz unc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hit_effs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;above&quot;</span><span class="p">][</span><span class="s2">&quot;eff&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hits</span><span class="p">[</span><span class="s2">&quot;below&quot;</span><span class="p">][</span><span class="s2">&quot;eff&quot;</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># muons, all panels, eff</span>

    <span class="k">def</span> <span class="nf">_compute_tracks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes tracks from hits according to the uncertainty and efficiency of the hits, computed as 1/(resolution*efficiency).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_track_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_start_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_muon_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">above_hits</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">above_hit_uncs</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">above_hit_effs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">lw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_start_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_muon_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">below_hits</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">below_hit_uncs</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">below_hit_effs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">lw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_filter_scatters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filters muons to avoid NaN/Inf gradients or values. This results in direct, in-place changes to the :class:`~tomopt.muon.muon_batch.MuonBatch`.</span>
<span class="sd">        This might seem heavy-handed, but tracks with invalid/extreme parameters can have NaN gradients, which can spoil the grads of all other muons.</span>

<span class="sd">        .. important::</span>
<span class="sd">            This method will remove any muon with at least one high-uncertainty hit, even if all the others are ok.</span>
<span class="sd">            This can mean that for some detector configurations with, e.g. one tiny detector, it might be best to manually remove the unneeded detector</span>
<span class="sd">            in order to gain an increase in the number of muons available for inference.</span>

<span class="sd">        The removal criteria are any of:</span>
<span class="sd">            total scattering is zero, NaN, or Inf</span>
<span class="sd">            incoming or outgoing tracks are parallel to the passive volume</span>
<span class="sd">            incoming or outgoing tracks are located far from the passive volume at the z-levels of its top or bottom</span>
<span class="sd">            Any hits associated with a muon are &gt;= 1e10</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Only include muons that scatter</span>
        <span class="n">theta_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_theta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_in</span><span class="p">)</span>
        <span class="n">theta_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_theta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_out</span><span class="p">)</span>

        <span class="n">theta_msc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_theta_msc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_out</span><span class="p">)</span>
        <span class="n">keep_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta_msc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">~</span><span class="n">theta_msc</span><span class="o">.</span><span class="n">isnan</span><span class="p">())</span> <span class="o">*</span> <span class="p">(</span><span class="o">~</span><span class="n">theta_msc</span><span class="o">.</span><span class="n">isinf</span><span class="p">())</span>

        <span class="c1"># Remove muons with tracks parallel to volume</span>
        <span class="n">keep_mask</span> <span class="o">*=</span> <span class="p">(</span><span class="n">theta_in</span> <span class="o">-</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e-5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta_out</span> <span class="o">-</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e-5</span><span class="p">)</span>

        <span class="c1"># Remove muons with tracks entering or exiting far from the volume</span>
        <span class="n">xy_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_xyz_in</span><span class="p">()[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">xy_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_xyz_out</span><span class="p">()[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">keep_mask</span> <span class="o">*=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">xy_in</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">lw</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">xy_in</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">lw</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">xy_out</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">lw</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">xy_out</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">lw</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span>

        <span class="c1"># Remove muons with high uncertainties; yes they get ignored during track fitting, but they can cause NaNs in the gradient</span>
        <span class="n">keep_mask</span> <span class="o">*=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hit_uncs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e10</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">keep_mask</span><span class="o">.</span><span class="n">squeeze_</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_mask</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>  <span class="c1"># Recompute tracks and hits</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">filter_muons</span><span class="p">(</span><span class="n">keep_mask</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">get_hits</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extract_hits</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_tracks</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute_scatters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes incoming and outgoing vectors, and the vector normal to them, from hits extracted from filtered muons.</span>

<span class="sd">        .. important::</span>
<span class="sd">            Currently only handles detectors above and below passive volume</span>

<span class="sd">        Scatter locations adapted from:</span>
<span class="sd">        @MISC {3334866,</span>
<span class="sd">            TITLE = {Closest points between two lines},</span>
<span class="sd">            AUTHOR = {Brian (https://math.stackexchange.com/users/72614/brian)},</span>
<span class="sd">            HOWPUBLISHED = {Mathematics Stack Exchange},</span>
<span class="sd">            NOTE = {URL:https://math.stackexchange.com/q/3334866 (version: 2019-08-26)},</span>
<span class="sd">            EPRINT = {https://math.stackexchange.com/q/3334866},</span>
<span class="sd">            URL = {https://math.stackexchange.com/q/3334866}</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_extract_hits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_tracks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filter_scatters</span><span class="p">()</span>

        <span class="c1"># Track computations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cross_track</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_out</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># connecting vector perpendicular to both lines</span>

        <span class="n">rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_start_out</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_start_in</span>
        <span class="n">lhs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">track_in</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">track_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cross_track</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># coefs = torch.linalg.solve(lhs, rhs)  # solve p1+t1*v1 + t3*v3 = p2+t2*v2 =&gt; p2-p1 = t1*v1 - t2*v2 + t3*v3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_coefs</span> <span class="o">=</span> <span class="p">(</span><span class="n">lhs</span><span class="o">.</span><span class="n">inverse</span><span class="p">()</span> <span class="o">@</span> <span class="n">rhs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_xyz_in</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muon,xyz) tensor the positions of the muons at the z-level of the top of the passive volume</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">get_passive_z_range</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_start_in</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># last panel to volume start</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_start_in</span> <span class="o">+</span> <span class="p">((</span><span class="n">dz</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_in</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_in</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_xyz_out</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muon,xyz) tensor the positions of the muons at the z-level of the bottom of the passive volume</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_start_out</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">get_passive_z_range</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># volume end to first panel</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_start_out</span> <span class="o">-</span> <span class="p">((</span><span class="n">dz</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_out</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_out</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_out_var_unc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the uncertainty on variable computed from the recorded hits due to the uncertainties on the hits, via gradient-based error propagation.</span>
<span class="sd">        This computation uses the triangle of the error matrix and does not assume zero-valued off-diagonal elements.</span>
<span class="sd">        .. warning::</span>
<span class="sd">            This computation assumes un-correlated uncertainties, which is probably ok.</span>
<span class="sd">        .. warning::</span>
<span class="sd">            This computation assumes un-correlated uncertainties, which is probably ok.</span>

<span class="sd">        .. warning::</span>
<span class="sd">            Behaviour tested only</span>
<span class="sd">        Arguments:</span>
<span class="sd">            var: (muons,*) tensor of variables computed from the recorded hits</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,*) tensor of uncertainties on var</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Compute dvar/dhits</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">jacobian</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reco_hits</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">unc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hit_uncs</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hit_uncs</span><span class="o">.</span><span class="n">type</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">hit_uncs</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">jac</span><span class="p">,</span> <span class="n">unc</span> <span class="o">=</span> <span class="n">jac</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">jac</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">jac</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">unc</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">unc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">unc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Compute unc^2 = sum[(unc_x*dvar/dhit_x)^2], summing over all n hits inclusive combinations</span>
        <span class="n">unc_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">jac</span> <span class="o">*</span> <span class="n">unc</span><span class="p">)</span><span class="o">.</span><span class="n">square</span><span class="p">()</span>  <span class="c1"># (mu,var,N)</span>
        <span class="k">return</span> <span class="n">unc_2</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>  <span class="c1"># (mu,var)</span>

    <span class="k">def</span> <span class="nf">_set_dtheta_dphi_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simultaneously sets dtheta and dphi scattering variables under the assumption of small angular scatterings.</span>
<span class="sd">        An assumption is necessary here, since there is a loss of information in the when the muons undergo scattering in theta and phi:</span>
<span class="sd">        since theta is [0,pi] a negative scattering in theta will always results in a positive theta, but phi can become phi+pi.</span>
<span class="sd">        When inferring the angular scattering, one cannot precisely tell whether instead a large scattering in phi occurred.</span>
<span class="sd">        The total scattering is computed as the (only) angle between incoming and outgoing tracks. Computation is done by the _compute_theta_msc() method.</span>
<span class="sd">        The final values of these are chosen using the hypothesis which minimises the total amount of scattering.</span>
<span class="sd">        This assumption has been tested and found to be good.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_dtheta_dphi_scatter</span><span class="p">(</span><span class="n">theta_in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_in</span><span class="p">,</span> <span class="n">phi_in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_in</span><span class="p">,</span> <span class="n">theta_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_out</span><span class="p">,</span> <span class="n">phi_out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtheta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dphi</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;dtheta&quot;</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;dphi&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtheta_unc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dphi_unc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hits</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of hits, as returned by :meth:`~tomopt.muon.muon_batch.MuonBatch.get_hits()`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hits</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reco_hits</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,hits,xyz) tensor of recorded hits</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reco_hits</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gen_hits</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,hits,xyz) tensor of true hits</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_hits</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_hits_above</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            Number of hits per muon in the &quot;above&quot; detectors</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_hits_above</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_hits_below</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            Number of hits per muon in the &quot;below&quot; detectors</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_hits_below</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">above_gen_hits</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,hits,xyz) tensor of true hits in the &quot;above&quot; detectors</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_hits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_hits</span><span class="p">[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_hits_above</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">below_gen_hits</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,hits,xyz) tensor of true hits in the &quot;below&quot; detectors</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_hits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_hits</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_hits_above</span> <span class="p">:]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">above_hits</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,hits,xyz) tensor of recorded hits in the &quot;above&quot; detectors</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reco_hits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reco_hits</span><span class="p">[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_hits_above</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">below_hits</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,hits,xyz) tensor of recorded hits in the &quot;below&quot; detectors</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reco_hits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reco_hits</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_hits_above</span> <span class="p">:]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hit_uncs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,hits,xyz) tensor of uncertainties on hits</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hit_uncs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hit_effs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,hits,eff) tensor of hit efficiencies</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hit_effs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">above_hit_uncs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,hits,xyz) tensor of uncertainties on hits in the &quot;above&quot; detectors</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hit_uncs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hit_uncs</span><span class="p">[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_hits_above</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">below_hit_uncs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,hits,xyz) tensor of uncertainties on hits in the &quot;below&quot; detectors</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hit_uncs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hit_uncs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_hits_above</span> <span class="p">:]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">above_hit_effs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,hits,effs) tensor of hit efficiencies in the &quot;above&quot; detectors</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hit_effs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hit_effs</span><span class="p">[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_hits_above</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">below_hit_effs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,hits,eff) tensor of hit efficiencies in the &quot;below&quot; detectors</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hit_effs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hit_effs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_hits_above</span> <span class="p">:]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">track_in</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,xyz) incoming xyz vector</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_in</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">track_start_in</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,xyz) initial point of incoming xyz vector</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_start_in</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">track_out</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,xyz) outgoing xyz vector</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_out</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">track_start_out</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,xyz) initial point of outgoing xyz vector</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_start_out</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">poca_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,xyz) xyz location of PoCA</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poca_xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">q1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_start_in</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_track_coefs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_in</span><span class="p">)</span>  <span class="c1"># closest point on v1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_poca_xyz</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_track_coefs</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cross_track</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Move halfway along v3 from q1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_poca_xyz_unc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poca_xyz</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">poca_xyz_unc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,xyz) uncertainty on poca_xyz</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poca_xyz_unc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_poca_xyz_unc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_out_var_unc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poca_xyz</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poca_xyz_unc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dxy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,xy) distances in x &amp; y from PoCA to incoming|outgoing muons</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dxy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_coefs</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cross_track</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dxy_unc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dxy</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dxy_unc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,xy) uncertainty on dxy</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dxy_unc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dxy_unc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_out_var_unc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dxy</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dxy_unc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">theta_in</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,1) theta of incoming muons</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_theta_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_theta_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_theta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_in</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_theta_in_unc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_theta_in</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">theta_in_unc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,1) uncertainty on theta_in</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_theta_in_unc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_theta_in_unc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_out_var_unc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_in</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_theta_in_unc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">theta_out</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,1) theta of outgoing muons</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_theta_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_theta_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_theta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_out</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_theta_out_unc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_theta_out</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">theta_out_unc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,1) uncertainty on theta_out</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_theta_out_unc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_theta_out_unc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_out_var_unc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_out</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_theta_out_unc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phi_in</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,1) phi of incoming muons</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phi_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phi_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_phi</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">track_in</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">track_in</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phi_in_unc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phi_in</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phi_in_unc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,1) uncertainty on phi_in</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phi_in_unc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phi_in_unc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_out_var_unc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_in</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phi_in_unc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phi_out</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,1) phi of outgoing muons</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phi_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phi_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_phi</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">track_out</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">track_out</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phi_out_unc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phi_out</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phi_out_unc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,1) uncertainty on phi_out</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phi_out_unc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_phi_out_unc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_out_var_unc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi_out</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phi_out_unc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtheta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,1) delta theta between incoming &amp; outgoing muons</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtheta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_dtheta_dphi_scatter</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtheta</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtheta_unc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,1) uncertainty on dtheta</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtheta_unc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dtheta_unc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_out_var_unc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtheta</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtheta_unc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dphi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,1) delta phi between incoming &amp; outgoing muons</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dphi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_dtheta_dphi_scatter</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dphi</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dphi_unc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,1) uncertainty on dphi</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dphi_unc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dphi_unc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_out_var_unc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dphi</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dphi_unc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">total_scatter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,1) theta_msc; the total amount of angular scattering</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_scatter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_total_scatter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_theta_msc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">track_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_out</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_total_scatter_unc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_scatter</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">total_scatter_unc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,1) uncertainty on total_scatter</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_scatter_unc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_total_scatter_unc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_out_var_unc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_scatter</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_scatter_unc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">theta_msc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,1) theta_msc; the total amount of angular scattering</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_scatter</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">theta_msc_unc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,1) uncertainty on total_scatter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_scatter_unc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">theta_xy_in</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,xy) decomposed theta and phi of incoming muons in the zx and zy planes</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_theta_xy_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_theta_xy_in</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_in</span><span class="o">.</span><span class="n">tan</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_in</span><span class="o">.</span><span class="n">cos</span><span class="p">())</span><span class="o">.</span><span class="n">arctan</span><span class="p">(),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_in</span><span class="o">.</span><span class="n">tan</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_in</span><span class="o">.</span><span class="n">sin</span><span class="p">())</span><span class="o">.</span><span class="n">arctan</span><span class="p">()],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_theta_xy_in_unc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_theta_xy_in</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">theta_xy_in_unc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,xy) uncertainty on theta_xy_in</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_theta_xy_in_unc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_theta_xy_in_unc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_out_var_unc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_xy_in</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_theta_xy_in_unc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">theta_xy_out</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,xy) decomposed theta and phi of outgoing muons in the zx and zy planes</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_theta_xy_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_theta_xy_out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_out</span><span class="o">.</span><span class="n">tan</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_out</span><span class="o">.</span><span class="n">cos</span><span class="p">())</span><span class="o">.</span><span class="n">arctan</span><span class="p">(),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_out</span><span class="o">.</span><span class="n">tan</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_out</span><span class="o">.</span><span class="n">sin</span><span class="p">())</span><span class="o">.</span><span class="n">arctan</span><span class="p">()],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_theta_xy_out_unc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_theta_xy_out</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">theta_xy_out_unc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,xy) uncertainty on theta_xy_out</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_theta_xy_out_unc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_theta_xy_out_unc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_out_var_unc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_xy_out</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_theta_xy_out_unc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtheta_xy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,xy) delta theta_xy between incoming &amp; outgoing muons in the zx and zy planes</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtheta_xy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dtheta_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_xy_in</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_xy_out</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dtheta_xy_unc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtheta_xy</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtheta_xy_unc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,xy) uncertainty on dtheta_xy</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtheta_xy_unc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dtheta_xy_unc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_out_var_unc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtheta_xy</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtheta_xy_unc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xyz_in</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,xyz) inferred xy position of muon at the z-level of the top of the passive volume</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xyz_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xyz_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_xyz_in</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xyz_in_unc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xyz_in</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xyz_in_unc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,xyz) uncertainty on xyz_in</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xyz_in_unc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xyz_in_unc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_out_var_unc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz_in</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xyz_in_unc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xyz_out</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,xyz) inferred xy position of muon at the z-level of the bottom of the passive volume</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xyz_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xyz_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_xyz_out</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xyz_out_unc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xyz_out</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xyz_out_unc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            (muons,xyz) uncertainty on xyz_out</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xyz_out_unc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_xyz_out_unc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_out_var_unc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz_out</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xyz_out_unc</span></div>


<div class="viewcode-block" id="GenScatterBatch"><a class="viewcode-back" href="../../../tomopt.inference.html#tomopt.inference.scattering.GenScatterBatch">[docs]</a><span class="k">class</span> <span class="nc">GenScatterBatch</span><span class="p">(</span><span class="n">ScatterBatch</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for computing scattering information from the true hits via incoming/outgoing trajectory fitting.</span>

<span class="sd">    .. warning::</span>
<span class="sd">        This class is intended for diagnostic purposes only.</span>
<span class="sd">        The tracks and scatter variables carry no gradient w.r.t. detector parameters (except z position).</span>

<span class="sd">    Linear fits are performed separately to all hits associated with layer groups, as indicated by the `pos` attribute of the layers which recorded hits.</span>
<span class="sd">    Currently, the inference methods expect detectors above the passive layer to have `pos==&#39;above&#39;`,</span>
<span class="sd">    and those below the passive volume to have `pos==&#39;below&#39;`.</span>
<span class="sd">    Trajectory fitting is performed using an analytic likelihood minimisation, but no uncertainties on the hits are considered.</span>

<span class="sd">    .. important::</span>
<span class="sd">        The current separation of hits into above and below groups does not allow for e.g. a third set of detectors,</span>
<span class="sd">        since this split is based on the value of the `n_hits_above` attribute.</span>

<span class="sd">    One instance of this class should created for each :class:`~tomopt.muon.muon_batch.MuonBatch`.</span>
<span class="sd">    As part of the initialisation, muons will be filtered using :meth:`~tomopt.inference.ScatterBatch._filter_scatters`</span>
<span class="sd">    in order to avoid NaN/Inf values. This results in direct, in-place changes to the :class:`~tomopt.muon.muon_batch.MuonBatch`.</span>

<span class="sd">    Since many variables of the scattering can be inferred, but not all are required for further inference downstream,</span>
<span class="sd">    variables, and their uncertainties, are computed on a lazy basis, with memoisation: the values are only computed on the first request (if at all)</span>
<span class="sd">    and then stored in case of further requests.</span>

<span class="sd">    The dtheta, dphi, and total scattering variables are computed under the assumption of small angular scatterings.</span>
<span class="sd">    An assumption is necessary here, since there is a loss of information in the when the muons undergo scattering in theta and phi:</span>
<span class="sd">    since theta is [0,pi] a negative scattering in theta will always results in a positive theta, but phi can become phi+pi.</span>
<span class="sd">    When inferring the angular scattering, one cannot precisely tell whether instead a large scattering in phi occurred.</span>
<span class="sd">    The total scattering (`total_scatter`) is the quadrature sum of dtheta and dphi, and all three are computed under both hypotheses.</span>
<span class="sd">    The final values of these are chosen using the hypothesis which minimises the total amount of scattering.</span>
<span class="sd">    This assumption has been tested and found to be good.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        mu: muons with hits to infer on</span>
<span class="sd">        volume: volume through which the muons travelled</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_compute_tracks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes tracks from true muon positions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_hit_uncs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gen_hits</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_in</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_start_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_muon_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">above_gen_hits</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">above_hit_uncs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">lw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_start_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_muon_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">below_gen_hits</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">below_hit_uncs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">lw</span><span class="p">)</span></div>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  <hr>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021-2024, TomOpt Authors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/GilesStrong/tomopt_sphinx_theme">theme</a> based on a <a href="https://github.com/pytorch/pytorch_sphinx_theme">theme</a> provided by <a href="https://pytorch.org/">PyTorch</a> based on a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/jquery.js"></script>
         <script src="../../../_static/underscore.js"></script>
         <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../../_static/doctools.js"></script>
         <script src="../../../_static/sphinx_highlight.js"></script>
     

  

  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-6 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer and user documentation for TomOpt</p>
          <a class="with-right-arrow" href="https://tomopt.readthedocs.io/en/stable">View Docs</a>
        </div>

        <div class="col-md-6 text-center">
          <h2>Tutorials</h2>
          <p>Get tutorials for beginner and advanced researchers demonstrating many of the features of TomOpt</p>
          <a class="with-right-arrow" href="https://github.com/GilesStrong/mode_muon_tomography#examples">View Tutorials</a>
        </div>

        <!-- <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="">View Resources</a>
        </div> -->
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://tomopt.readthedocs.io/en/stable" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <!-- <li class="list-title"><a href="https://tomopt.readthedocs.io/en/stable">TomOpt</a></li> -->
            <!-- <li><a href="">Get Started</a></li> -->
            <!-- <li><a href="">Features</a></li> -->
            <!-- <li><a href="">Ecosystem</a></li> -->
            <!-- <li><a href="">Blog</a></li> -->
            <!-- <li><a href="">Resources</a></li> -->
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="">Support</a></li>
            <li><a href="https://github.com/GilesStrong/mode_muon_tomography#examples">Tutorials</a></li>
            <li><a href="https://tomopt.readthedocs.io/en/stable">Docs</a></li>
            <!-- <li><a href="" target="_blank">Discuss</a></li> -->
            <li><a href="https://github.com/GilesStrong/mode_muon_tomography/blob/main/CHANGES.md" target="_blank">Change Log</a></li>
            <li><a href="https://github.com/GilesStrong/mode_muon_tomography/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://github.com/GilesStrong/mode_muon_tomography/blob/main/CITATION.md" target="_blank">Citation</a></li>
            <!-- <li><a href="" target="_blank">Slack</a></li> -->
            <!-- <li><a href="https://github.com/GilesStrong/mode_muon_tomography/blob/main/CONTRIBUTING.md" target="_blank">Contributing</a></li> -->
          </ul>
        </div>

        <!-- <div class="footer-links-col follow-us-col">
          <ul>
            <li class="list-title">Follow Us</li>
            <li>
              <div id="mc_embed_signup">
                <form
                  action="https://twitter.us14.list-manage.com/subscribe/post?u=75419c71fe0a935e53dfa4a3f&id=91d0dccd39"
                  method="post"
                  id="mc-embedded-subscribe-form"
                  name="mc-embedded-subscribe-form"
                  class="email-subscribe-form validate"
                  target="_blank"
                  novalidate>
                  <div id="mc_embed_signup_scroll" class="email-subscribe-form-fields-wrapper">
                    <div class="mc-field-group">
                      <label for="mce-EMAIL" style="display:none;">Email Address</label>
                      <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address">
                    </div>

                    <div id="mce-responses" class="clear">
                      <div class="response" id="mce-error-response" style="display:none"></div>
                      <div class="response" id="mce-success-response" style="display:none"></div>
                    </div>    real people should not fill this in and expect good things - do not remove this or risk form bot signups

                    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_75419c71fe0a935e53dfa4a3f_91d0dccd39" tabindex="-1" value=""></div>

                    <div class="clear">
                      <input type="submit" value="" name="subscribe" id="mc-embedded-subscribe" class="button email-subscribe-button">
                    </div>
                  </div>
                </form>
              </div>

            </li>
          </ul>

          <div class="footer-social-icons">
            <a href="" target="_blank" class="facebook"></a>
            <a href="" target="_blank" class="twitter"></a>
          </div>
        </div> -->
      </div>
    </div>
  </footer>

  <!-- <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebooks Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../_static/images/pytorch-x.svg">
  </div>
</div> -->

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://tomopt.readthedocs.io/en/stable" aria-label="TomOpt"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <!-- <li>
            <a href="#">Get Started</a>
          </li> -->

          <!-- <li>
            <a href="#">Features</a>
          </li> -->

          <!-- <li>
            <a href="#">Ecosystem</a>
          </li> -->

          <!-- <li>
            <a href="">Blog</a>
          </li> -->

          <li>
            <a href="https://github.com/GilesStrong/mode_muon_tomography#examples">Tutorials</a>
          </li>

          <li>
            <a href="https://tomopt.readthedocs.io/en/stable">Docs</a>
          </li>

          <!-- <li>
            <a href="">Resources</a>
          </li> -->

          <li>
            <a href="https://github.com/GilesStrong/mode_muon_tomography">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>