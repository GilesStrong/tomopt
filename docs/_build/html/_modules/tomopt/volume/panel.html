


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>tomopt.volume.panel &mdash; TomOpt  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/tomopt_logo.png"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://tomopt.readthedocs.io/en/stable" aria-label="TomOpt"></a>

      <div class="main-menu">
        <ul>
          <!-- <li>
            <a href="">Get Started</a>
          </li> -->

          <!-- <li>
            <a href="">Features</a>
          </li> -->

          <!-- <li>
            <a href="">Ecosystem</a>
          </li> -->

          <!-- <li>
            <a href="">Blog</a>
          </li> -->

          <li>
            <a href="https://github.com/GilesStrong/mode_muon_tomography#examples">Tutorials</a>
          </li>

          <li>
            <a href="https://tomopt.readthedocs.io/en/stable">Docs</a>
          </li>

          <!-- <li>
            <a href="">Resources</a>
          </li> -->

          <li>
            <a href="https://github.com/GilesStrong/mode_muon_tomography">Github</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>

  </div>
</div>


<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html#testing">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html#external-repos">External repos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html#authors">Authors</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tomopt.html">tomopt package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tomopt.muon.html">tomopt.muon package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tomopt.volume.html">tomopt.volume package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tomopt.inference.html">tomopt.inference package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tomopt.optimisation.html">tomopt.optimisation package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tomopt.plotting.html">tomopt.plotting package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tomopt.benchmarks.html">tomopt.benchmarks package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../index.html">Module code</a> &gt;</li>
        
      <li>tomopt.volume.panel</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for tomopt.volume.panel</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">nn</span>

<span class="kn">from</span> <span class="nn">..core</span> <span class="kn">import</span> <span class="n">DEVICE</span>
<span class="kn">from</span> <span class="nn">..muon</span> <span class="kn">import</span> <span class="n">MuonBatch</span>

<span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Provides implementations of class simulating panel-style detectors with learnable positions and xy sizes.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DetectorPanel&quot;</span><span class="p">,</span> <span class="s2">&quot;SigmoidDetectorPanel&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="DetectorPanel"><a class="viewcode-back" href="../../../tomopt.volume.html#tomopt.volume.panel.DetectorPanel">[docs]</a><span class="k">class</span> <span class="nc">DetectorPanel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provides an infinitely thin, rectangular panel in the xy plane, centred at a learnable xyz position (metres, in absolute position in the volume frame),</span>
<span class="sd">    with a learnable width in x and y (`xy_span`).</span>
<span class="sd">    Whilst this class can be used manually, it is designed to be used by the :class:`~tomopt.volume.layer.PanelDetectorLayer` class.</span>

<span class="sd">    Despite inheriting from `nn.Module`, the `forward` method should not be called, instead passing a :class:`~tomopt.muon.muon_batch.MuonBatch` to the</span>
<span class="sd">    `get_hits` method will return hits corresponding to the muons.</span>

<span class="sd">    During training model (`.train()` or `.training` is True), a continuous model of the resolution and efficiency will be used, such that hits are differentiable w.r.t.</span>
<span class="sd">    the learnable parameters of the panel. This means that muons outside of the physical panel will have hits at non-zero resolution.</span>
<span class="sd">    The current model is a 2D uncorrelated Gaussian in xy, centred over the panel, with width parameters equal to the xy_spans/4,</span>
<span class="sd">    i.e. the panel is 4-sigma across.</span>

<span class="sd">    Efficiency is accounted for via a weighting approach, rather than deciding whether to record hits or not, i.e. muons will always record hits,</span>
<span class="sd">    but the probability of the hit actually being recorded is computable.</span>

<span class="sd">    During evaluation mode (`.eval()` or `.training` is False), if the panel is set to use `realistic_validation`, then the physical panel will be simulated:</span>
<span class="sd">    Muons outside the panel have zero resolution and efficiency, resulting in NaN hits positions.</span>
<span class="sd">    Muons inside the panel will have the full resolution and efficiency of the panel,</span>
<span class="sd">    but hits will not be differentiable w.r.t. the panel xy-position or xy-span.</span>
<span class="sd">    If `realistic_validation` is False, then the continuous model will be used also in evaluation mode.</span>

<span class="sd">    The cost of the panel is based on the supplied cost per metre squared, and the current area of the panel, according to its learnt xy-span.</span>
<span class="sd">    Panels can also be run in &quot;fixed-budget&quot; mode, in which a cost of the panel is specified via the `.assign_budget` method.</span>
<span class="sd">    Based on the cost per m^2, the panel will change in effective width, based on its learn xy_span (now an aspect ratio), such that its area results in a cost</span>
<span class="sd">    equal to the specified cost of the panel.</span>

<span class="sd">    The resolution and efficiency remain fixed at the specified values.</span>
<span class="sd">    If intending to run in &quot;fixed-budget&quot; mode, then a budget can be specified here,</span>
<span class="sd">    however the :class&quot;`~tomopt.volume.volume.Volume` class will pass through all panels and initialise their budgets.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        res: resolution of the panel in m^-1, i.e. a higher value improves the precision on the hit recording</span>
<span class="sd">        eff: efficiency of the hit recording of the panel, indicated as a probability [0,1]</span>
<span class="sd">        init_xyz: initial xyz position of the panel in metres in the volume frame</span>
<span class="sd">        init_xy_span: initial xy-span (total width) of the panel in metres</span>
<span class="sd">        m2_cost: the cost in unit currency of the 1 square metre of detector</span>
<span class="sd">        budget: optional required cost of the panel. Based on the span and cost per m^2, the panel will resize to meet the required cost</span>
<span class="sd">        realistic_validation: if True, will use the physical interpretation of the panel during evaluation</span>
<span class="sd">        device: device on which to place tensors</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">res</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">eff</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">init_xyz</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">init_xy_span</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">m2_cost</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">budget</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">realistic_validation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">DEVICE</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Panel initialiser with user-supplied initial positions and widths.</span>
<span class="sd">        The resolution and efficiency remain fixed at the specified values.</span>
<span class="sd">        If intending to run in &quot;fixed-budget&quot; mode, then a budget can be specified here,</span>
<span class="sd">        however the :class&quot;`~tomopt.volume.volume.Volume` class will pass through all panels and initialise their budgets.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">res</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Resolution must be positive&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eff</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Efficiency must be positive&quot;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">realistic_validation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">realistic_validation</span><span class="p">,</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;m2_cost&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">m2_cost</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;resolution&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;efficiency&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">eff</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xy</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">init_xyz</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">init_xyz</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xy_span</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">init_xy_span</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">budget_scale</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assign_budget</span><span class="p">(</span><span class="n">budget</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="si">}</span><span class="s2"> located at xy=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="o">.</span><span class="n">data</span><span class="si">}</span><span class="s2">, z=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">data</span><span class="si">}</span><span class="s2">, and xy span </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_scaled_xy_span</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="si">}</span><span class="s2"> with budget scale </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">budget_scale</span><span class="o">.</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="DetectorPanel.get_scaled_xy_span"><a class="viewcode-back" href="../../../tomopt.volume.html#tomopt.volume.panel.DetectorPanel.get_scaled_xy_span">[docs]</a>    <span class="k">def</span> <span class="nf">get_scaled_xy_span</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the effective size of the panel by rescaling based on the xy-span, cost per m^2, and budget.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Rescaled xy-span such that the panel has a cost equal to the specified budget</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy_span</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">budget_scale</span></div>

<div class="viewcode-block" id="DetectorPanel.get_xy_mask"><a class="viewcode-back" href="../../../tomopt.volume.html#tomopt.volume.panel.DetectorPanel.get_xy_mask">[docs]</a>    <span class="k">def</span> <span class="nf">get_xy_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xy</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes which of the xy points lie inside the physical panel.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            xy: xy2) tensor of points</span>

<span class="sd">        Returns:</span>
<span class="sd">            (N,) Boolean mask, where True indicates the point lies inside the panel</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">span</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scaled_xy_span</span><span class="p">()</span>
        <span class="n">xy_low</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span> <span class="o">-</span> <span class="p">(</span><span class="n">span</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">xy_high</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span> <span class="o">+</span> <span class="p">(</span><span class="n">span</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">xy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">xy_low</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xy_high</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">xy_low</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xy_high</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="DetectorPanel.get_gauss"><a class="viewcode-back" href="../../../tomopt.volume.html#tomopt.volume.panel.DetectorPanel.get_gauss">[docs]</a>    <span class="k">def</span> <span class="nf">get_gauss</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Normal</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            A Gaussian distribution, with 2 uncorrelated components corresponding to x and y, centred at the xy position of the panel, and sigma = panel span/4</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scaled_xy_span</span><span class="p">()</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># We say that the panel widths corresponds to 2-sigma of the Gaussian</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid parameters for Gaussian: loc=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="si">}</span><span class="s2">, scale=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_scaled_xy_span</span><span class="p">()</span> <span class="o">/</span> <span class="mi">4</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DetectorPanel.get_resolution"><a class="viewcode-back" href="../../../tomopt.volume.html#tomopt.volume.panel.DetectorPanel.get_resolution">[docs]</a>    <span class="k">def</span> <span class="nf">get_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xy</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the xy resolutions of panel at the supplied list of xy points.</span>
<span class="sd">        If running in evaluation mode with `realistic_validation`,</span>
<span class="sd">        then these will be the full resolution of the panel for points inside the panel (indicated by the mask), and zero outside.</span>
<span class="sd">        Otherwise, the Gaussian model will be used.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            xy: (N,xy) tensor of positions</span>
<span class="sd">            mask: optional pre-computed (N,) Boolean mask, where True indicates that the xy point is inside the panel.</span>
<span class="sd">                Only used in evaluation mode and if `realistic_validation` is True.</span>
<span class="sd">                If required, but not supplied, than will be computed automatically.</span>

<span class="sd">        Returns:</span>
<span class="sd">            res, a (N,xy) tensor of the resolution at the xy points</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="si">}</span><span class="s2"> is not a Tensor for some reason.&quot;</span><span class="p">)</span>  <span class="c1"># To appease MyPy</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">realistic_validation</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gauss</span><span class="p">()</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">xy</span><span class="p">))</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">))</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp_min</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">)</span>  <span class="c1"># To avoid NaN gradients</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xy_mask</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">xy</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># Zero detection outside detector</span>
            <span class="n">res</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="DetectorPanel.get_efficiency"><a class="viewcode-back" href="../../../tomopt.volume.html#tomopt.volume.panel.DetectorPanel.get_efficiency">[docs]</a>    <span class="k">def</span> <span class="nf">get_efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xy</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the efficiency of panel at the supplied list of xy points.</span>
<span class="sd">        If running in evaluation mode with `realistic_validation`,</span>
<span class="sd">        then these will be the full efficiency of the panel for points inside the panel (indicated by the mask), and zero outside.</span>
<span class="sd">        Otherwise, the Gaussian model will be used.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            xy: (N,) or (N,xy) tensor of positions</span>
<span class="sd">            mask: optional pre-computed (N,) Boolean mask, where True indicates that the xy point is inside the panel.</span>
<span class="sd">                Only used in evaluation mode and if `realistic_validation` is True.</span>
<span class="sd">                If required, but not supplied, than will be computed automatically.</span>

<span class="sd">        Returns:</span>
<span class="sd">            eff, a (N,)tensor of the efficiency at the xy points</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">efficiency</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">efficiency</span><span class="si">}</span><span class="s2"> is not a Tensor for some reason.&quot;</span><span class="p">)</span>  <span class="c1"># To appease MyPy</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">realistic_validation</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gauss</span><span class="p">()</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">xy</span><span class="p">))</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">)))</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">eff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">efficiency</span> <span class="o">*</span> <span class="n">scale</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xy_mask</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
            <span class="n">eff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xy</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># Zero detection outside detector</span>
            <span class="n">eff</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">efficiency</span>
        <span class="k">return</span> <span class="n">eff</span></div>

<div class="viewcode-block" id="DetectorPanel.assign_budget"><a class="viewcode-back" href="../../../tomopt.volume.html#tomopt.volume.panel.DetectorPanel.assign_budget">[docs]</a>    <span class="k">def</span> <span class="nf">assign_budget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">budget</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the budget for the panel. This is then used to set a multiplicative coefficient, `budget_scale`, based on the `m2_cost`</span>
<span class="sd">        which rescales the `xy_span` such that the area of the resulting panel matches the assigned budget.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            budget: required cost of the panel in unit currency</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">budget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">budget_scale</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">budget</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m2_cost</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy_span</span><span class="o">.</span><span class="n">prod</span><span class="p">()))</span></div>

<div class="viewcode-block" id="DetectorPanel.get_hits"><a class="viewcode-back" href="../../../tomopt.volume.html#tomopt.volume.panel.DetectorPanel.get_hits">[docs]</a>    <span class="k">def</span> <span class="nf">get_hits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="n">MuonBatch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The main interaction method with the panel: returns hits for the supplied muons.</span>
<span class="sd">        Hits consist of:</span>
<span class="sd">            reco_xy: (muons,xy) tensor of reconstructed xy positions of muons included simulated resolution</span>
<span class="sd">            gen_xy: (muons,xy) tensor of generator-level (true) xy positions of muons</span>
<span class="sd">            z: z position of the panel</span>

<span class="sd">        If running in evaluation mode with `realistic_validation`,</span>
<span class="sd">        then these will be the full resolution of the panel for points inside the panel (indicated by the mask), and zero outside.</span>
<span class="sd">        Otherwise, the Gaussian model will be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">span</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scaled_xy_span</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">get_xy_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span> <span class="o">-</span> <span class="p">(</span><span class="n">span</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span> <span class="o">+</span> <span class="p">(</span><span class="n">span</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># Muons in panel</span>
        <span class="n">true_mu_xy</span> <span class="o">=</span> <span class="n">mu</span><span class="o">.</span><span class="n">xy</span><span class="o">.</span><span class="n">data</span>

        <span class="n">xy0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span> <span class="o">-</span> <span class="p">(</span><span class="n">span</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Low-left of panel</span>
        <span class="n">rel_xy</span> <span class="o">=</span> <span class="n">true_mu_xy</span> <span class="o">-</span> <span class="n">xy0</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resolution</span><span class="p">(</span><span class="n">true_mu_xy</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="n">rel_xy</span> <span class="o">=</span> <span class="n">rel_xy</span> <span class="o">+</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">/</span> <span class="n">res</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">realistic_validation</span><span class="p">:</span>  <span class="c1"># Prevent reco hit from exiting panel</span>
            <span class="n">np_span</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">rel_xy</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">rel_xy</span><span class="p">[</span><span class="n">mask</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np_span</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">rel_xy</span><span class="p">[</span><span class="n">mask</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np_span</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">reco_xy</span> <span class="o">=</span> <span class="n">xy0</span> <span class="o">+</span> <span class="n">rel_xy</span>

        <span class="n">reco_xyz</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">reco_xy</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">reco_xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span>
        <span class="n">gen_xyz</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">true_mu_xy</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">gen_xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;reco_xyz&quot;</span><span class="p">:</span> <span class="n">reco_xyz</span><span class="p">,</span>
            <span class="s2">&quot;gen_xyz&quot;</span><span class="p">:</span> <span class="n">gen_xyz</span><span class="p">,</span>
            <span class="s2">&quot;unc_xyz&quot;</span><span class="p">:</span> <span class="n">F</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">res</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>  <span class="c1"># Add zero for z unc</span>
            <span class="s2">&quot;eff&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_efficiency</span><span class="p">(</span><span class="n">true_mu_xy</span><span class="p">,</span> <span class="n">mask</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">hits</span></div>

<div class="viewcode-block" id="DetectorPanel.get_cost"><a class="viewcode-back" href="../../../tomopt.volume.html#tomopt.volume.panel.DetectorPanel.get_cost">[docs]</a>    <span class="k">def</span> <span class="nf">get_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            current cost of the panel according to its area and m2_cost</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2_cost</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scaled_xy_span</span><span class="p">()</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span></div>

<div class="viewcode-block" id="DetectorPanel.clamp_params"><a class="viewcode-back" href="../../../tomopt.volume.html#tomopt.volume.panel.DetectorPanel.clamp_params">[docs]</a>    <span class="k">def</span> <span class="nf">clamp_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xyz_low</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">xyz_high</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensures that the panel is centred within the supplied xyz range,</span>
<span class="sd">        and that the span of the panel is between xyz_high/20 and xyz_high*10.</span>
<span class="sd">        A small random number &lt; 1e-3 is added/subtracted to the min/max z position of the panel, to ensure it doesn&#39;t overlap with other panels.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            xyz_low: minimum x,y,z values for the panel centre in metres</span>
<span class="sd">            xyz_high: maximum x,y,z values for the panel centre in metres</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">)</span>  <span class="c1"># prevent hits at same z due to clamping</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">clamp_</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">xyz_low</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">xyz_high</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">clamp_</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">xyz_low</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">max</span><span class="o">=</span><span class="n">xyz_high</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">clamp_</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">xyz_low</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">eps</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">xyz_high</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xy_span</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">clamp_</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">xyz_high</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">20</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">xyz_high</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xy_span</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clamp_</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">xyz_high</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">20</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">xyz_high</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="DetectorPanel.forward"><a class="viewcode-back" href="../../../tomopt.volume.html#tomopt.volume.panel.DetectorPanel.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Please do not use forward, instead use get_hits&quot;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="SigmoidDetectorPanel"><a class="viewcode-back" href="../../../tomopt.volume.html#tomopt.volume.panel.SigmoidDetectorPanel">[docs]</a><span class="k">class</span> <span class="nc">SigmoidDetectorPanel</span><span class="p">(</span><span class="n">DetectorPanel</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provides an infinitely thin, rectangular panel in the xy plane, centred at a learnable xyz position (metres, in absolute position in the volume frame),</span>
<span class="sd">    with a learnable width in x and y (`xy_span`).</span>
<span class="sd">    Whilst this class can be used manually, it is designed to be used by the :class:`~tomopt.volume.layer.PanelDetectorLayer` class.</span>

<span class="sd">    Despite inheriting from `nn.Module`, the `forward` method should not be called, instead passing a :class:`~tomopt.muon.muon_batch.MuonBatch` to the</span>
<span class="sd">    `get_hits` method will return hits corresponding to the muons.</span>

<span class="sd">    During training model (`.train()` or `.training` is True), a continuous model of the resolution and efficiency will be used, such that hits are</span>
<span class="sd">    differentiable w.r.t. the learnable parameters of the panel. This means that muons outside of the physical panel will have hits at non-zero resolution.</span>
<span class="sd">    The model is a 2D uncorrelated Sigmoid in xy, centred over the panel, which pass 0.5 at the xy_spans/2.</span>
<span class="sd">    The smoothness of the sigmoid affects the rate of change of resolution|efficiency near the edge of the physical border:</span>
<span class="sd">    A higher smooth value provides a slower change, with higher resolution|efficiency outside the physical panel, whereas a lower smooth value provides a</span>
<span class="sd">    sharper transition, with lower sensitivity to muons outside the panel (and therefore more strongly approximated a physical panel).</span>
<span class="sd">    The :class:`~tomopt.optimisation.callbacks.detector_callbacks.SigmoidPanelSmoothnessSchedule` can be used to anneal this smoothness during optimisation.</span>

<span class="sd">    Efficiency is accounted for via a weighting approach, rather than deciding whether to record hits or not, i.e. muons will always record hits,</span>
<span class="sd">    but the probability of the hit actually being recorded is computable.</span>

<span class="sd">    During evaluation mode (`.eval()` or `.training` is False), if the panel is set to use `realistic_validation`, then the physical panel will be simulated:</span>
<span class="sd">    Muons outside the panel have zero resolution and efficiency, resulting in NaN hits positions.</span>
<span class="sd">    Muons inside the panel will have the full resolution and efficiency of the panel,</span>
<span class="sd">    but hits will not be differentiable w.r.t. the panel xy-position or xy-span.</span>
<span class="sd">    If `realistic_validation` is False, then the continuous model will be used also in evaluation mode.</span>

<span class="sd">    The cost of the panel is based on the supplied cost per metre squared, and the current area of the panel, according to its learnt xy-span.</span>
<span class="sd">    Panels can also be run in &quot;fixed-budget&quot; mode, in which a cost of the panel is specified via the `.assign_budget` method.</span>
<span class="sd">    Based on the cost per m^2, the panel will change in effective width, based on its learn xy_span (now an aspect ratio), such that its area results in a cost</span>
<span class="sd">    equal to the specified cost of the panel.</span>

<span class="sd">    The resolution and efficiency remain fixed at the specified values.</span>
<span class="sd">    If intending to run in &quot;fixed-budget&quot; mode, then a budget can be specified here,</span>
<span class="sd">    however the :class&quot;`~tomopt.volume.volume.Volume` class will pass through all panels and initialise their budgets.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        smooth: smoothness of the sigmoid: A higher smooth value provides a slower change, with higher resolution|efficiency outside the physical panel,</span>
<span class="sd">            whereas a lower smooth value provides a sharper transition, with lower sensitivity to muons outside the panel</span>
<span class="sd">            (and therefore more strongly approximated a physical panel).</span>
<span class="sd">        res: resolution of the panel in m^-1, i.e. a higher value improves the precision on the hit recording</span>
<span class="sd">        eff: efficiency of the hit recording of the panel, indicated as a probability [0,1]</span>
<span class="sd">        init_xyz: initial xyz position of the panel in metres in the volume frame</span>
<span class="sd">        init_xy_span: initial xy-span (total width) of the panel in metres</span>
<span class="sd">        m2_cost: the cost in unit currency of the 1 square metre of detector</span>
<span class="sd">        budget: optional required cost of the panel. Based on the span and cost per m^2, the panel will resize to meet the required cost</span>
<span class="sd">        realistic_validation: if True, will use the physical interpretation of the panel during evaluation</span>
<span class="sd">        device: device on which to place tensors</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">smooth</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="n">res</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">eff</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">init_xyz</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">init_xy_span</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">m2_cost</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">budget</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">realistic_validation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">DEVICE</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
            <span class="n">eff</span><span class="o">=</span><span class="n">eff</span><span class="p">,</span>
            <span class="n">init_xyz</span><span class="o">=</span><span class="n">init_xyz</span><span class="p">,</span>
            <span class="n">init_xy_span</span><span class="o">=</span><span class="n">init_xy_span</span><span class="p">,</span>
            <span class="n">m2_cost</span><span class="o">=</span><span class="n">m2_cost</span><span class="p">,</span>
            <span class="n">budget</span><span class="o">=</span><span class="n">budget</span><span class="p">,</span>
            <span class="n">realistic_validation</span><span class="o">=</span><span class="n">realistic_validation</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Smooth will be massaged to Tensor, but MyPy doesn&#39;t spot this</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth</span> <span class="o">=</span> <span class="n">smooth</span>  <span class="c1"># type: ignore</span>

<div class="viewcode-block" id="SigmoidDetectorPanel.sig_model"><a class="viewcode-back" href="../../../tomopt.volume.html#tomopt.volume.panel.SigmoidDetectorPanel.sig_model">[docs]</a>    <span class="k">def</span> <span class="nf">sig_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xy</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Models fractional resolution and efficiency from a sigmoid-based model to provide a smooth and differentiable model of a physical detector-panel.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            xy: (N,xy) tensor of positions</span>

<span class="sd">        Returns:</span>
<span class="sd">            Multiplicative coefficients for the nominal resolution or efficiency of the panel based on the xy position relative to the panel position and size</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">half_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scaled_xy_span</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">xy</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">)</span> <span class="o">/</span> <span class="n">half_width</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">coef</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth</span><span class="p">)</span></div>

<div class="viewcode-block" id="SigmoidDetectorPanel.get_resolution"><a class="viewcode-back" href="../../../tomopt.volume.html#tomopt.volume.panel.SigmoidDetectorPanel.get_resolution">[docs]</a>    <span class="k">def</span> <span class="nf">get_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xy</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the xy resolutions of panel at the supplied list of xy points.</span>
<span class="sd">        If running in evaluation mode with `realistic_validation`,</span>
<span class="sd">        then these will be the full resolution of the panel for points inside the panel (indicated by the mask), and zero outside.</span>
<span class="sd">        Otherwise, the Sigmoid model will be used.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            xy: (N,xy) tensor of positions</span>
<span class="sd">            mask: optional pre-computed (N,) Boolean mask, where True indicates that the xy point is inside the panel.</span>
<span class="sd">                Only used in evaluation mode and if `realistic_validation` is True.</span>
<span class="sd">                If required, but not supplied, than will be computed automatically.</span>

<span class="sd">        Returns:</span>
<span class="sd">            res, a (N,xy) tensor of the resolution at the xy points</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="si">}</span><span class="s2"> is not a Tensor for some reason.&quot;</span><span class="p">)</span>  <span class="c1"># To appease MyPy</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">realistic_validation</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig_model</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp_min</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">)</span>  <span class="c1"># To avoid NaN gradients</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xy_mask</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">xy</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># Zero detection outside detector</span>
            <span class="n">res</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="SigmoidDetectorPanel.get_efficiency"><a class="viewcode-back" href="../../../tomopt.volume.html#tomopt.volume.panel.SigmoidDetectorPanel.get_efficiency">[docs]</a>    <span class="k">def</span> <span class="nf">get_efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xy</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the efficiency of panel at the supplied list of xy points.</span>
<span class="sd">        If running in evaluation mode with `realistic_validation`,</span>
<span class="sd">        then these will be the full efficiency of the panel for points inside the panel (indicated by the mask), and zero outside.</span>
<span class="sd">        Otherwise, the Sigmoid model will be used.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            xy: (N,) or (N,xy) tensor of positions</span>
<span class="sd">            mask: optional pre-computed (N,) Boolean mask, where True indicates that the xy point is inside the panel.</span>
<span class="sd">                Only used in evaluation mode and if `realistic_validation` is True.</span>
<span class="sd">                If required, but not supplied, than will be computed automatically.</span>

<span class="sd">        Returns:</span>
<span class="sd">            eff, a (N,)tensor of the efficiency at the xy points</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">efficiency</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">efficiency</span><span class="si">}</span><span class="s2"> is not a Tensor for some reason.&quot;</span><span class="p">)</span>  <span class="c1"># To appease MyPy</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">realistic_validation</span><span class="p">:</span>
            <span class="n">eff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">efficiency</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig_model</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">eff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp_min</span><span class="p">(</span><span class="n">eff</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">)</span>  <span class="c1"># To avoid NaN gradients</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xy_mask</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
            <span class="n">eff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xy</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># Zero detection outside detector</span>
            <span class="n">eff</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">efficiency</span>
        <span class="k">return</span> <span class="n">eff</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">smooth</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smooth</span>

    <span class="nd">@smooth</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">smooth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smooth</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">smooth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;smooth argument must be positive and non-zero&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">smooth</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
            <span class="n">smooth</span> <span class="o">=</span> <span class="n">Tensor</span><span class="p">([</span><span class="n">smooth</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_smooth&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_smooth</span> <span class="o">=</span> <span class="n">smooth</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;_smooth&quot;</span><span class="p">,</span> <span class="n">smooth</span><span class="p">)</span></div>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  <hr>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021-2024, TomOpt Authors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/GilesStrong/tomopt_sphinx_theme">theme</a> based on a <a href="https://github.com/pytorch/pytorch_sphinx_theme">theme</a> provided by <a href="https://pytorch.org/">PyTorch</a> based on a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/jquery.js"></script>
         <script src="../../../_static/underscore.js"></script>
         <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../../_static/doctools.js"></script>
         <script src="../../../_static/sphinx_highlight.js"></script>
     

  

  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-6 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer and user documentation for TomOpt</p>
          <a class="with-right-arrow" href="https://tomopt.readthedocs.io/en/stable">View Docs</a>
        </div>

        <div class="col-md-6 text-center">
          <h2>Tutorials</h2>
          <p>Get tutorials for beginner and advanced researchers demonstrating many of the features of TomOpt</p>
          <a class="with-right-arrow" href="https://github.com/GilesStrong/mode_muon_tomography#examples">View Tutorials</a>
        </div>

        <!-- <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="">View Resources</a>
        </div> -->
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://tomopt.readthedocs.io/en/stable" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <!-- <li class="list-title"><a href="https://tomopt.readthedocs.io/en/stable">TomOpt</a></li> -->
            <!-- <li><a href="">Get Started</a></li> -->
            <!-- <li><a href="">Features</a></li> -->
            <!-- <li><a href="">Ecosystem</a></li> -->
            <!-- <li><a href="">Blog</a></li> -->
            <!-- <li><a href="">Resources</a></li> -->
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="">Support</a></li>
            <li><a href="https://github.com/GilesStrong/mode_muon_tomography#examples">Tutorials</a></li>
            <li><a href="https://tomopt.readthedocs.io/en/stable">Docs</a></li>
            <!-- <li><a href="" target="_blank">Discuss</a></li> -->
            <li><a href="https://github.com/GilesStrong/mode_muon_tomography/blob/main/CHANGES.md" target="_blank">Change Log</a></li>
            <li><a href="https://github.com/GilesStrong/mode_muon_tomography/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://github.com/GilesStrong/mode_muon_tomography/blob/main/CITATION.md" target="_blank">Citation</a></li>
            <!-- <li><a href="" target="_blank">Slack</a></li> -->
            <!-- <li><a href="https://github.com/GilesStrong/mode_muon_tomography/blob/main/CONTRIBUTING.md" target="_blank">Contributing</a></li> -->
          </ul>
        </div>

        <!-- <div class="footer-links-col follow-us-col">
          <ul>
            <li class="list-title">Follow Us</li>
            <li>
              <div id="mc_embed_signup">
                <form
                  action="https://twitter.us14.list-manage.com/subscribe/post?u=75419c71fe0a935e53dfa4a3f&id=91d0dccd39"
                  method="post"
                  id="mc-embedded-subscribe-form"
                  name="mc-embedded-subscribe-form"
                  class="email-subscribe-form validate"
                  target="_blank"
                  novalidate>
                  <div id="mc_embed_signup_scroll" class="email-subscribe-form-fields-wrapper">
                    <div class="mc-field-group">
                      <label for="mce-EMAIL" style="display:none;">Email Address</label>
                      <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address">
                    </div>

                    <div id="mce-responses" class="clear">
                      <div class="response" id="mce-error-response" style="display:none"></div>
                      <div class="response" id="mce-success-response" style="display:none"></div>
                    </div>    real people should not fill this in and expect good things - do not remove this or risk form bot signups

                    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_75419c71fe0a935e53dfa4a3f_91d0dccd39" tabindex="-1" value=""></div>

                    <div class="clear">
                      <input type="submit" value="" name="subscribe" id="mc-embedded-subscribe" class="button email-subscribe-button">
                    </div>
                  </div>
                </form>
              </div>

            </li>
          </ul>

          <div class="footer-social-icons">
            <a href="" target="_blank" class="facebook"></a>
            <a href="" target="_blank" class="twitter"></a>
          </div>
        </div> -->
      </div>
    </div>
  </footer>

  <!-- <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../_static/images/pytorch-x.svg">
  </div>
</div> -->

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://tomopt.readthedocs.io/en/stable" aria-label="TomOpt"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <!-- <li>
            <a href="#">Get Started</a>
          </li> -->

          <!-- <li>
            <a href="#">Features</a>
          </li> -->

          <!-- <li>
            <a href="#">Ecosystem</a>
          </li> -->

          <!-- <li>
            <a href="">Blog</a>
          </li> -->

          <li>
            <a href="https://github.com/GilesStrong/mode_muon_tomography#examples">Tutorials</a>
          </li>

          <li>
            <a href="https://tomopt.readthedocs.io/en/stable">Docs</a>
          </li>

          <!-- <li>
            <a href="">Resources</a>
          </li> -->

          <li>
            <a href="https://github.com/GilesStrong/mode_muon_tomography">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>